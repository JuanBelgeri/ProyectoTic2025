<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checkout | PizzUM&BurgUM</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#FF0000', secondary: '#000000' } }
            }
        }
    </script>
    <style>
        html, body { height:100%; margin:0; padding:0; }
        body { overflow-x:hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #FF0000; border-radius: 10px; }
        .badge { font-size: 20px; line-height: 1; }
    </style>
</head>
<body class="bg-gray-50 font-sans custom-scrollbar">
<!-- Nav -->
<nav class="bg-gradient-to-r from-primary to-secondary shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <span class="text-xl font-bold text-white">PizzUM&BurgUM</span>
            </div>
            <div class="hidden md:flex items-center space-x-8">
                <a href="home.html" class="text-white hover:text-gray-200 text-sm font-medium">Inicio</a>
                <a href="builder.html" class="text-white hover:text-gray-200 text-sm font-medium">Elegir Constructor</a>
                <span class="text-white text-sm font-medium">Checkout</span>
            </div>
            <div class="md:hidden flex items-center">
                <button class="text-white hover:text-gray-200" aria-controls="mobile-menu">‚ò∞</button>
            </div>
        </div>
    </div>
</nav>

<!-- Checkout -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-3xl font-extrabold text-gray-900">Resumen y Pago</h1>
    <p class="mt-2 text-gray-600">Revis√° tu pedido y completa tu direcci√≥n y forma de pago.</p>

    <div id="loading-state" class="mt-8 text-center text-gray-500">
        <p>Cargando carrito...</p>
    </div>

    <div id="content" class="hidden mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Carrito -->
        <section class="lg:col-span-2">
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-800">Tu Carrito</h2>
                    <button id="clear-cart" class="text-sm text-red-600 hover:underline">Vaciar carrito</button>
                </div>

                <!-- Lista de √≠tems -->
                <div id="cart-list" class="mt-4 divide-y"></div>

                <!-- Estado vac√≠o -->
                <div id="empty-state" class="hidden mt-8 text-center text-gray-500">
                    <p>Tu carrito est√° vac√≠o.</p>
                    <a href="builder.html" class="mt-3 inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50">
                        üçïüçî Ir a construir una pizza o burger
                    </a>
                </div>

                <!-- CTA -->
                <div id="cart-actions" class="hidden mt-6 flex flex-wrap items-center gap-3">
                    <a href="builder.html" class="inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50">
                        ‚ûï Agregar m√°s creaciones
                    </a>
                </div>
            </div>
        </section>

        <!-- Direcci√≥n / Pago / Totales -->
        <aside class="lg:col-span-1 space-y-6">
            <!-- Direcci√≥n -->
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800">Direcci√≥n de env√≠o</h3>
                <div class="mt-3 space-y-3">
                    <input id="addr-street" type="text" class="w-full border rounded-md p-2" placeholder="Calle y n√∫mero" required>
                    <input id="addr-city" type="text" class="w-full border rounded-md p-2" placeholder="Ciudad/Barrio" required>
                    <input id="addr-ref" type="text" class="w-full border rounded-md p-2" placeholder="Referencia (opcional)">
                </div>
            </div>

            <!-- Pago -->
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800">M√©todo de pago</h3>
                <div class="mt-3 space-y-2">
                    <label class="flex items-center border rounded-lg p-3 cursor-pointer hover:border-primary">
                        <input type="radio" name="payment" value="cash" class="text-primary mr-2" checked>
                        <span>Efectivo</span>
                    </label>
                    <label class="flex items-center border rounded-lg p-3 cursor-pointer hover:border-primary">
                        <input type="radio" name="payment" value="card" class="text-primary mr-2">
                        <span>Tarjeta de cr√©dito/d√©bito</span>
                    </label>
                </div>

                <!-- Datos de tarjeta (condicional) -->
                <div id="card-block" class="hidden mt-4 space-y-3">
                    <input id="card-number" type="text" inputmode="numeric" maxlength="19" class="w-full border rounded-md p-2" placeholder="N√∫mero de tarjeta">
                    <div class="grid grid-cols-3 gap-3">
                        <input id="card-exp" type="text" class="border rounded-md p-2" placeholder="MM/AA">
                        <input id="card-cvv" type="password" maxlength="4" class="border rounded-md p-2" placeholder="CVV">
                        <input id="card-name" type="text" class="border rounded-md p-2" placeholder="Nombre">
                    </div>
                </div>
            </div>

            <!-- Totales -->
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800">Resumen</h3>
                <dl class="mt-3 space-y-2 text-gray-700">
                    <div class="flex justify-between">
                        <dt>Subtotal</dt><dd id="dl-subtotal" class="font-semibold">$0.00</dd>
                    </div>
                    <div class="flex justify-between border-t pt-2 text-lg">
                        <dt>Total</dt><dd id="dl-total" class="font-extrabold text-primary">$0.00</dd>
                    </div>
                </dl>

                <button id="place-order" class="mt-6 w-full inline-flex justify-center items-center px-4 py-3 rounded-md text-white bg-primary hover:bg-opacity-90">
                    ‚úîÔ∏è Confirmar pedido
                </button>
                <p id="error-message" class="mt-3 text-sm text-red-600 hidden"></p>
            </div>
        </aside>
    </div>
</main>

<footer class="bg-gray-800">
    <div class="max-w-7xl mx-auto py-12 px-4 overflow-hidden sm:px-6 lg:px-8">
        <p class="text-center text-base text-gray-400">&copy; 2025 PizzUM&BurgUM. Todos los derechos reservados.</p>
    </div>
</footer>

<script src="api.js"></script>
<script>
    let cartItems = [];

    function isLoggedIn() {
        return !!localStorage.getItem('authToken');
    }

    async function loadCartData() {
        try {
            console.log('Loading cart data...');

            const cartRes = await getCart();
            console.log('Cart response:', cartRes);

            if (cartRes.success) {
                cartItems = cartRes.data?.items || [];
                console.log('Cart items loaded:', cartItems);
            } else {
                console.error('Cart error:', cartRes.message);
                showError('Error al cargar carrito: ' + (cartRes.message || 'Unknown error'));
                return;
            }

            renderCart();
            updateTotals();
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

        } catch (error) {
            console.error('Error loading checkout data:', error);
            showError('Error al cargar datos del checkout: ' + error.message);
        }
    }

    function renderCart() {
        const list = document.getElementById('cart-list');
        const empty = document.getElementById('empty-state');
        const actions = document.getElementById('cart-actions');

        list.innerHTML = '';

        if (!cartItems.length) {
            empty.classList.remove('hidden');
            actions.classList.add('hidden');
            return;
        }

        empty.classList.add('hidden');
        actions.classList.remove('hidden');

        cartItems.forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = "py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3";
            row.innerHTML = `
          <div class="flex items-start gap-3 flex-1">
            <div class="badge">${item.itemType === 'HAMBURGER' ? 'üçî' : 'üçï'}</div>
            <div class="flex-1">
              <div class="font-semibold text-gray-800">${item.itemName || (item.itemType === 'HAMBURGER' ? 'Hamburguesa' : 'Pizza')}</div>
              <div class="text-sm text-gray-600">Precio unitario: $${(item.unitPrice || 0).toFixed(2)}</div>
              <div class="text-sm font-semibold text-primary">Subtotal: $${(item.subtotal || 0).toFixed(2)}</div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button class="qty-minus text-gray-500 hover:text-primary font-bold px-2 py-1 border rounded" data-cart-id="${item.id}" data-index="${idx}">‚àí</button>
            <input type="number" class="qty-input w-12 text-center border rounded px-2 py-1" value="${item.quantity}" min="1" data-cart-id="${item.id}" data-index="${idx}">
            <button class="qty-plus text-gray-500 hover:text-primary font-bold px-2 py-1 border rounded" data-cart-id="${item.id}" data-index="${idx}">+</button>
          </div>

          <button class="delete-item text-red-600 hover:text-red-800 hover:underline text-sm whitespace-nowrap" data-cart-id="${item.id}" data-index="${idx}">
            Eliminar
          </button>
        `;
            list.appendChild(row);
        });

        setupCartEventListeners();
    }

    function updateTotals() {
        const subtotal = cartItems.reduce((acc, item) => acc + (item.subtotal || 0), 0);
        document.getElementById('dl-subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('dl-total').textContent = `$${subtotal.toFixed(2)}`;
    }

    function setupCartEventListeners() {
        // Quantity minus button
        document.querySelectorAll('.qty-minus').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const cartId = btn.dataset.cartId;
                const currentQty = parseInt(document.querySelector(`.qty-input[data-cart-id="${cartId}"]`).value);

                if (currentQty > 1) {
                    await updateQuantity(cartId, currentQty - 1);
                }
            });
        });

        // Quantity plus button
        document.querySelectorAll('.qty-plus').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const cartId = btn.dataset.cartId;
                const currentQty = parseInt(document.querySelector(`.qty-input[data-cart-id="${cartId}"]`).value);
                await updateQuantity(cartId, currentQty + 1);
            });
        });

        // Quantity input change
        document.querySelectorAll('.qty-input').forEach(input => {
            input.addEventListener('change', async (e) => {
                const cartId = input.dataset.cartId;
                const newQty = parseInt(input.value) || 1;

                if (newQty < 1) {
                    input.value = 1;
                    return;
                }

                await updateQuantity(cartId, newQty);
            });
        });

        // Delete button
        document.querySelectorAll('.delete-item').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const cartId = btn.dataset.cartId;

                if (confirm('¬øEst√°s seguro de que quieres eliminar este item del carrito?')) {
                    await removeFromCart(cartId);
                }
            });
        });
    }

    async function updateQuantity(cartId, newQuantity) {
        try {
            const response = await fetch(`http://localhost:8081/api/cart/item/${cartId}?quantity=${newQuantity}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Update local cart item
                const item = cartItems.find(i => i.id === parseInt(cartId));
                if (item) {
                    item.quantity = newQuantity;
                    item.subtotal = item.unitPrice * newQuantity;
                }

                renderCart();
                updateTotals();
            } else {
                showError('Error al actualizar cantidad: ' + (data.message || 'Error desconocido'));
            }
        } catch (error) {
            showError('Error al actualizar cantidad: ' + error.message);
            console.error('Update quantity error:', error);
        }
    }

    async function removeFromCart(cartId) {
        try {
            const response = await fetch(`http://localhost:8081/api/cart/item/${cartId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Remove from local cart
                cartItems = cartItems.filter(i => i.id !== parseInt(cartId));
                renderCart();
                updateTotals();
                showError('Item eliminado del carrito');
            } else {
                showError('Error al eliminar item: ' + (data.message || 'Error desconocido'));
            }
        } catch (error) {
            showError('Error al eliminar item: ' + error.message);
            console.error('Remove from cart error:', error);
        }
    }

    function showError(message) {
        const errorEl = document.getElementById('error-message');
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        setTimeout(() => {
            errorEl.classList.add('hidden');
        }, 5000);
    }

    document.addEventListener('change', (e) => {
        if (e.target.name === 'payment') {
            document.getElementById('card-block').classList.toggle('hidden', e.target.value !== 'card');
        }
    });

    document.getElementById('clear-cart').addEventListener('click', async () => {
        if (confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) {
            try {
                const response = await fetch('http://localhost:8081/api/cart/clear?userEmail=' + encodeURIComponent(localStorage.getItem('userEmail')), {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    cartItems = [];
                    renderCart();
                    updateTotals();
                    showError('Carrito vaciado');
                } else {
                    showError('Error al vaciar carrito: ' + (data.message || 'Error desconocido'));
                }
            } catch (error) {
                showError('Error al vaciar carrito: ' + error.message);
                console.error('Clear cart error:', error);
            }
        }
    });

    document.getElementById('place-order').addEventListener('click', async () => {
        if (!cartItems.length) {
            showError('Tu carrito est√° vac√≠o');
            return;
        }

        const street = document.getElementById('addr-street').value.trim();
        const city = document.getElementById('addr-city').value.trim();
        const payment = document.querySelector('input[name="payment"]:checked')?.value;

        if (!street || !city) {
            showError('Por favor completa la direcci√≥n de env√≠o');
            return;
        }

        if (!payment) {
            showError('Por favor selecciona un m√©todo de pago');
            return;
        }

        if (payment === 'card') {
            const cardNumber = document.getElementById('card-number').value.trim();
            const cardExp = document.getElementById('card-exp').value.trim();
            const cardCvv = document.getElementById('card-cvv').value.trim();
            const cardName = document.getElementById('card-name').value.trim();

            if (!cardNumber || !cardExp || !cardCvv || !cardName) {
                showError('Por favor completa los datos de la tarjeta');
                return;
            }
        }

        const btn = document.getElementById('place-order');
        btn.disabled = true;
        btn.textContent = 'Creando pedido...';

        try {
            const response = await createOrder({
                addressId: 1,
                paymentMethodId: 1,
                notes: `Direcci√≥n: ${street}, ${city}. Referencia: ${document.getElementById('addr-ref').value.trim()}`
            });

            console.log('Order response:', response);

            if (response.success) {
                window.location.href = `order.html?id=${response.data.id}`;
            } else {
                showError(response.message || 'Error al crear pedido');
                btn.disabled = false;
                btn.textContent = '‚úîÔ∏è Confirmar pedido';
            }
        } catch (error) {
            console.error('Error creating order:', error);
            showError('Error al crear pedido: ' + error.message);
            btn.disabled = false;
            btn.textContent = '‚úîÔ∏è Confirmar pedido';
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (!isLoggedIn()) {
            window.location.href = 'home.html';
            return;
        }
        loadCartData();
    });
</script>
</body>
</html>