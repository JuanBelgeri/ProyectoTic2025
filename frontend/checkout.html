<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checkout | PizzUM&BurgUM</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#FF0000', secondary: '#000000' } }
            }
        }
    </script>
    <style>
        html, body { height:100%; margin:0; padding:0; }
        body { overflow-x:hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #FF0000; border-radius: 10px; }
        .badge { font-size: 20px; line-height: 1; }
    </style>
</head>
<body class="bg-gray-50 font-sans custom-scrollbar">
<!-- Nav -->
<nav class="bg-gradient-to-r from-primary to-secondary shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <span class="text-xl font-bold text-white">PizzUM&BurgUM</span>
            </div>
            <div class="hidden md:flex items-center space-x-8">
                <a href="home.html" class="text-white hover:text-gray-200 text-sm font-medium">Inicio</a>
                <a href="builder.html" class="text-white hover:text-gray-200 text-sm font-medium">Elegir Constructor</a>
                <!-- User Profile Dropdown (only visible when logged in) -->
                <div id="user-profile-menu" class="relative hidden">
                    <button id="user-profile-btn" class="flex items-center text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium focus:outline-none transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Mi Cuenta
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="user-profile-dropdown" class="hidden absolute right-0 mt-2 w-64 rounded-lg shadow-xl bg-white border-2 border-gray-100 z-50 overflow-hidden transition-all duration-200">
                        <div class="py-2" role="menu">
                            <!-- Client-only options -->
                            <a href="orden.html" id="dropdown-orders" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                Mis Pedidos
                            </a>
                            <a href="favorites.html" id="dropdown-favorites" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                Favoritos
                            </a>
                            <a href="account.html#addresses" id="dropdown-addresses" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Editar Domicilios
                            </a>
                            <a href="account.html#payments" id="dropdown-payments" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                </svg>
                                Editar Medios de Pago
                            </a>
                            <div id="dropdown-divider" class="border-t border-gray-200 my-1 hidden"></div>
                            <button id="profile-logout-btn" class="flex items-center w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-primary transition-colors duration-150 group" role="menuitem">
                                <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Cerrar sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>
                <button id="nav-auth-btn" class="bg-white text-primary px-4 py-2 rounded-full font-bold hover:bg-gray-100 transition duration-300">
                    Ingresar
                </button>
            </div>
            <div class="md:hidden flex items-center">
                <button class="text-white hover:text-gray-200" aria-controls="mobile-menu">‚ò∞</button>
            </div>
        </div>
    </div>
</nav>

<!-- Checkout -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-3xl font-extrabold text-gray-900">Resumen y Pago</h1>
    <p class="mt-2 text-gray-600">Revis√° tu pedido y completa tu direcci√≥n y forma de pago.</p>

    <div id="loading-state" class="mt-8 text-center text-gray-500">
        <p>Cargando carrito...</p>
    </div>

    <div id="content" class="hidden mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Carrito -->
        <section class="lg:col-span-2">
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-800">Tu Carrito</h2>
                    <button id="clear-cart" class="text-sm text-red-600 hover:underline">Vaciar carrito</button>
                </div>

                <!-- Lista de √≠tems -->
                <div id="cart-list" class="mt-4 divide-y"></div>

                <!-- Estado vac√≠o -->
                <div id="empty-state" class="hidden mt-8 text-center text-gray-500">
                    <p>Tu carrito est√° vac√≠o.</p>
                    <a href="builder.html" class="mt-3 inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50">
                        üçïüçî Ir a construir una pizza o burger
                    </a>
                </div>

                <!-- CTA -->
                <div id="cart-actions" class="hidden mt-6 flex flex-wrap items-center gap-3">
                    <a href="builder.html" class="inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50">
                        ‚ûï Agregar m√°s creaciones
                    </a>
                </div>
            </div>
        </section>

        <!-- Direcci√≥n / Pago / Totales -->
        <aside class="lg:col-span-1 space-y-6">
            <!-- Direcci√≥n -->
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-gray-800">Direcci√≥n de env√≠o</h3>
                    <button id="btn-add-address" class="text-sm text-primary hover:underline">+ Agregar nueva</button>
                </div>
                
                <!-- Selector de direcciones existentes -->
                <div id="address-selector" class="space-y-2">
                    <div class="text-sm text-gray-500">Cargando direcciones...</div>
                </div>

                <!-- Formulario para nueva direcci√≥n -->
                <div id="new-address-form" class="hidden mt-4 pt-4 border-t space-y-3">
                    <input id="new-addr-street" type="text" class="w-full border rounded-md p-2" placeholder="Calle y n√∫mero" required>
                    <input id="new-addr-number" type="text" class="w-full border rounded-md p-2" placeholder="N√∫mero" required>
                    <input id="new-addr-apartment" type="text" class="w-full border rounded-md p-2" placeholder="Apartamento (opcional)">
                    <input id="new-addr-city" type="text" class="w-full border rounded-md p-2" placeholder="Ciudad/Barrio" required>
                    <input id="new-addr-postal" type="text" class="w-full border rounded-md p-2" placeholder="C√≥digo postal" required>
                    <input id="new-addr-info" type="text" class="w-full border rounded-md p-2" placeholder="Referencia adicional (opcional)">
                    <div class="flex items-center">
                        <input id="new-addr-main" type="checkbox" class="mr-2">
                        <label for="new-addr-main" class="text-sm text-gray-700">Marcar como direcci√≥n principal</label>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-save-address" class="flex-1 px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90">Guardar</button>
                        <button id="btn-cancel-address" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancelar</button>
                    </div>
                    <p id="address-error" class="text-sm text-red-600 hidden"></p>
                </div>
            </div>

            <!-- Pago -->
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-gray-800">M√©todo de pago</h3>
                    <button id="btn-add-payment" class="text-sm text-primary hover:underline">+ Agregar nueva</button>
                </div>
                
                <!-- Selector de m√©todos de pago existentes -->
                <div id="payment-selector" class="space-y-2">
                    <div id="payment-methods-list" class="text-sm text-gray-500">Cargando m√©todos de pago...</div>
                </div>

                <!-- Formulario para nuevo m√©todoo de pago -->
                <div id="new-payment-form" class="hidden mt-4 pt-4 border-t space-y-3">
                    <select id="new-payment-type" class="w-full border rounded-md p-2">
                        <option value="CREDIT">Tarjeta de Cr√©dito</option>
                        <option value="DEBIT">Tarjeta de D√©bito</option>
                    </select>
                    <input id="new-payment-card" type="text" inputmode="numeric" maxlength="19" class="w-full border rounded-md p-2" placeholder="N√∫mero de tarjeta" required>
                    <input id="new-payment-name" type="text" class="w-full border rounded-md p-2" placeholder="Nombre del titular" required>
                    <input id="new-payment-exp" type="text" class="w-full border rounded-md p-2" placeholder="MM/AA" required>
                    <div class="flex items-center">
                        <input id="new-payment-main" type="checkbox" class="mr-2">
                        <label for="new-payment-main" class="text-sm text-gray-700">Marcar como m√©todo principal</label>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-save-payment" class="flex-1 px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90">Guardar</button>
                        <button id="btn-cancel-payment" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancelar</button>
                    </div>
                    <p id="payment-error" class="text-sm text-red-600 hidden"></p>
                </div>
            </div>

            <!-- Totales -->
            <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
                <h3 class="text-lg font-bold text-gray-800">Resumen</h3>
                <dl class="mt-3 space-y-2 text-gray-700">
                    <div class="flex justify-between">
                        <dt>Subtotal</dt><dd id="dl-subtotal" class="font-semibold">$0.00</dd>
                    </div>
                    <div class="flex justify-between border-t pt-2 text-lg">
                        <dt>Total</dt><dd id="dl-total" class="font-extrabold text-primary">$0.00</dd>
                    </div>
                </dl>

                <button id="place-order" class="mt-6 w-full inline-flex justify-center items-center px-4 py-3 rounded-md text-white bg-primary hover:bg-opacity-90">
                    Confirmar pedido
                </button>
                <p id="error-message" class="mt-3 text-sm text-red-600 hidden"></p>
            </div>
        </aside>
    </div>
</main>

<footer class="bg-gray-800">
    <div class="max-w-7xl mx-auto py-12 px-4 overflow-hidden sm:px-6 lg:px-8">
        <p class="text-center text-base text-gray-400">&copy; 2025 PizzUM&BurgUM. Todos los derechos reservados.</p>
    </div>
</footer>

<script src="api.js"></script>
<script>
    let cartItems = [];

    function isLoggedIn() {
        return !!localStorage.getItem('authToken');
    }

    async function loadCartData() {
        try {
            console.log('Loading cart data...');

            const cartData = await getCart();
            console.log('Cart data:', cartData);

            if (cartData && cartData.items) {
                cartItems = cartData.items || [];
                console.log('Cart items loaded:', cartItems);
                
                // Fetch details for each item to get ingredients
                await loadItemDetails();
            } else {
                cartItems = [];
                console.log('Cart is empty');
            }

            renderCart();
            updateTotals();
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

        } catch (error) {
            console.error('Error loading checkout data:', error);
            showError('Error al cargar datos del checkout: ' + error.message);
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }
    }

    async function loadItemDetails() {
        // Load details for all items in parallel
        const detailPromises = cartItems.map(async (item) => {
            try {
                let details = null;
                if (item.itemType === 'PIZZA') {
                    const response = await getPizzaById(item.itemId);
                    if (response.success && response.data) {
                        details = response.data;
                    }
                } else if (item.itemType === 'HAMBURGER') {
                    const response = await getHamburgerById(item.itemId);
                    if (response.success && response.data) {
                        details = response.data;
                    }
                }
                return { item, details };
            } catch (error) {
                console.error(`Error loading details for item ${item.itemId}:`, error);
                return { item, details: null };
            }
        });

        const results = await Promise.all(detailPromises);
        
        // Store details in cartItems
        results.forEach(({ item, details }) => {
            const cartItem = cartItems.find(ci => ci.id === item.id);
            if (cartItem) {
                cartItem.details = details;
            }
        });
    }

    function renderCart() {
        const list = document.getElementById('cart-list');
        const empty = document.getElementById('empty-state');
        const actions = document.getElementById('cart-actions');

        list.innerHTML = '';

        if (!cartItems.length) {
            empty.classList.remove('hidden');
            actions.classList.add('hidden');
            return;
        }

        empty.classList.add('hidden');
        actions.classList.remove('hidden');

        cartItems.forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = "py-4 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3";
            
            // Build ingredients HTML
            let ingredientsHtml = '';
            if (item.details) {
                const details = item.details;
                const ingredients = [];
                
                if (item.itemType === 'PIZZA') {
                    if (details.sizeName && details.sizeName !== 'None') {
                        ingredients.push(`<strong>Tama√±o:</strong> ${details.sizeName}`);
                    }
                    if (details.doughName && details.doughName !== 'None') {
                        ingredients.push(`<strong>Masa:</strong> ${details.doughName}`);
                    }
                    if (details.sauceName && details.sauceName !== 'None') {
                        ingredients.push(`<strong>Salsa:</strong> ${details.sauceName}`);
                    }
                    if (details.cheeseName && details.cheeseName !== 'None') {
                        ingredients.push(`<strong>Queso:</strong> ${details.cheeseName}`);
                    }
                    if (details.toppings && details.toppings !== 'None') {
                        const toppingsList = details.toppings.split(',').map(t => t.trim()).join(', ');
                        ingredients.push(`<strong>Toppings:</strong> ${toppingsList}`);
                    }
                } else if (item.itemType === 'HAMBURGER') {
                    if (details.breadName && details.breadName !== 'None') {
                        ingredients.push(`<strong>Pan:</strong> ${details.breadName}`);
                    }
                    if (details.meatName && details.meatName !== 'None') {
                        ingredients.push(`<strong>Carne:</strong> ${details.meatName}`);
                    }
                    if (details.cheeseName && details.cheeseName !== 'None') {
                        ingredients.push(`<strong>Queso:</strong> ${details.cheeseName}`);
                    }
                    if (details.toppings && details.toppings !== 'None') {
                        const toppingsList = details.toppings.split(',').map(t => t.trim()).join(', ');
                        ingredients.push(`<strong>Toppings:</strong> ${toppingsList}`);
                    }
                    if (details.condiments && details.condiments !== 'None') {
                        const condimentsList = details.condiments.split(',').map(c => c.trim()).join(', ');
                        ingredients.push(`<strong>Condimentos:</strong> ${condimentsList}`);
                    }
                }
                
                if (ingredients.length > 0) {
                    ingredientsHtml = `
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <p class="text-xs font-semibold text-gray-700 mb-1">Ingredientes:</p>
                            <div class="text-xs text-gray-600 space-y-1">
                                ${ingredients.map(ing => `<div>${ing}</div>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            row.innerHTML = `
          <div class="flex items-start gap-3 flex-1">
            <div class="badge">${item.itemType === 'HAMBURGER' ? 'üçî' : 'üçï'}</div>
            <div class="flex-1">
              <div class="font-semibold text-gray-800">${item.itemName || (item.itemType === 'HAMBURGER' ? 'Hamburguesa' : 'Pizza')}</div>
              ${ingredientsHtml}
              <div class="text-sm text-gray-600 mt-2">Precio unitario: $${(item.unitPrice || 0).toFixed(2)}</div>
              <div class="text-sm font-semibold text-primary">Subtotal: $${(item.subtotal || 0).toFixed(2)}</div>
            </div>
          </div>

          <div class="flex items-center gap-2 sm:flex-col sm:items-end">
            <div class="flex items-center gap-2">
              <button class="qty-minus text-gray-500 hover:text-primary font-bold px-2 py-1 border rounded" data-cart-id="${item.id}" data-index="${idx}">‚àí</button>
              <input type="number" class="qty-input w-12 text-center border rounded px-2 py-1" value="${item.quantity}" min="1" data-cart-id="${item.id}" data-index="${idx}">
              <button class="qty-plus text-gray-500 hover:text-primary font-bold px-2 py-1 border rounded" data-cart-id="${item.id}" data-index="${idx}">+</button>
            </div>
            <button class="delete-item text-red-600 hover:text-red-800 hover:underline text-sm whitespace-nowrap mt-2 sm:mt-0" data-cart-id="${item.id}" data-index="${idx}">
              Eliminar
            </button>
          </div>
        `;
            list.appendChild(row);
        });

        setupCartEventListeners();
    }

    function updateTotals() {
        const subtotal = cartItems.reduce((acc, item) => acc + (item.subtotal || 0), 0);
        document.getElementById('dl-subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('dl-total').textContent = `$${subtotal.toFixed(2)}`;
    }

    function setupCartEventListeners() {
        // Quantity minus button
        document.querySelectorAll('.qty-minus').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const cartId = btn.dataset.cartId;
                const currentQty = parseInt(document.querySelector(`.qty-input[data-cart-id="${cartId}"]`).value);

                if (currentQty > 1) {
                    await updateQuantity(cartId, currentQty - 1);
                }
            });
        });

        // Quantity plus button
        document.querySelectorAll('.qty-plus').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const cartId = btn.dataset.cartId;
                const currentQty = parseInt(document.querySelector(`.qty-input[data-cart-id="${cartId}"]`).value);
                await updateQuantity(cartId, currentQty + 1);
            });
        });

        // Quantity input change
        document.querySelectorAll('.qty-input').forEach(input => {
            input.addEventListener('change', async (e) => {
                const cartId = input.dataset.cartId;
                const newQty = parseInt(input.value) || 1;

                if (newQty < 1) {
                    input.value = 1;
                    return;
                }

                await updateQuantity(cartId, newQty);
            });
        });

        // Delete button
        document.querySelectorAll('.delete-item').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const cartId = btn.dataset.cartId;

                if (confirm('¬øEst√°s seguro de que quieres eliminar este item del carrito?')) {
                    await deleteCartItem(cartId);
                }
            });
        });
    }

    async function updateQuantity(cartId, newQuantity) {
        try {
            const response = await updateCartQuantity(parseInt(cartId), newQuantity);

            if (response.success) {
                // Reload cart to get updated data
                await loadCartData();
            } else {
                showError('Error al actualizar cantidad: ' + (response.message || 'Error desconocido'));
            }
        } catch (error) {
            showError('Error al actualizar cantidad: ' + error.message);
            console.error('Update quantity error:', error);
        }
    }

    async function deleteCartItem(cartId) {
        try {
            const response = await removeFromCart(parseInt(cartId));

            if (response.success) {
                // Reload cart to get updated data
                await loadCartData();
            } else {
                showError('Error al eliminar item: ' + (response.message || 'Error desconocido'));
            }
        } catch (error) {
            showError('Error al eliminar item: ' + error.message);
            console.error('Remove from cart error:', error);
        }
    }

    let selectedAddressId = null;
    let selectedPaymentMethodId = null;
    let addresses = [];
    let paymentMethods = [];

    async function loadAddressesAndPayments() {
        try {
            // Load addresses
            const addressesRes = await getUserAddresses();
            if (addressesRes.success && addressesRes.data) {
                addresses = Array.isArray(addressesRes.data) ? addressesRes.data : [];
            } else {
                addresses = [];
            }

            // Load payment methods
            const paymentsRes = await getUserPaymentMethods();
            if (paymentsRes.success && paymentsRes.data) {
                paymentMethods = Array.isArray(paymentsRes.data) ? paymentsRes.data : [];
            } else {
                paymentMethods = [];
            }

            renderAddressSelector();
            renderPaymentSelector();
        } catch (error) {
            console.error('Error loading addresses and payments:', error);
            addresses = [];
            paymentMethods = [];
            renderAddressSelector();
            renderPaymentSelector();
        }
    }

    function renderAddressSelector() {
        const selector = document.getElementById('address-selector');
        if (!selector) return;

        if (addresses.length === 0) {
            selector.innerHTML = '<div class="text-sm text-gray-500">No tienes direcciones guardadas. Agrega una nueva.</div>';
            return;
        }

        selector.innerHTML = addresses.map(addr => {
            const addressText = `${addr.street} ${addr.number}${addr.apartment ? ', ' + addr.apartment : ''}, ${addr.city}${addr.postalCode ? ' (' + addr.postalCode + ')' : ''}${addr.isMain ? ' <span class="text-xs text-primary font-semibold">(Principal)</span>' : ''}`;
            return `
                <label class="flex items-start border rounded-lg p-3 cursor-pointer hover:border-primary ${selectedAddressId === addr.id ? 'border-primary bg-primary bg-opacity-5' : ''}">
                    <input type="radio" name="address" value="${addr.id}" class="text-primary mr-2 mt-1" ${selectedAddressId === addr.id ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-gray-800">${addressText}</div>
                        ${addr.additionalInfo ? `<div class="text-xs text-gray-500 mt-1">${addr.additionalInfo}</div>` : ''}
                    </div>
                </label>
            `;
        }).join('');

        // Add event listeners
        selector.querySelectorAll('input[name="address"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedAddressId = parseInt(e.target.value);
                renderAddressSelector();
            });
        });

        // Select first address by default if none selected
        if (selectedAddressId === null && addresses.length > 0) {
            const mainAddress = addresses.find(addr => addr.isMain) || addresses[0];
            selectedAddressId = mainAddress.id;
            renderAddressSelector();
        }
    }

    function renderPaymentSelector() {
        const list = document.getElementById('payment-methods-list');
        if (!list) return;

        if (paymentMethods.length === 0) {
            list.innerHTML = '<div class="text-sm text-gray-500 mt-2">No tienes m√©todos de pago guardados. Agrega uno nuevo.</div>';
            return;
        }

        list.innerHTML = paymentMethods.map(pm => {
            const cardDisplay = pm.cardNumberEncrypted || '****';
            const typeText = pm.type === 'CREDIT' ? 'Cr√©dito' : 'D√©bito';
            return `
                <label class="flex items-center border rounded-lg p-3 cursor-pointer hover:border-primary mt-2 ${selectedPaymentMethodId === pm.id ? 'border-primary bg-primary bg-opacity-5' : ''}">
                    <input type="radio" name="payment" value="${pm.id}" class="text-primary mr-2" ${selectedPaymentMethodId === pm.id ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="text-sm font-medium text-gray-800">Tarjeta ${typeText} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${cardDisplay.slice(-4)}</div>
                        <div class="text-xs text-gray-500">${pm.cardHolder}${pm.expirationDate ? ' ‚Ä¢ ' + pm.expirationDate : ''}${pm.isMain ? ' <span class="text-primary font-semibold">(Principal)</span>' : ''}</div>
                    </div>
                </label>
            `;
        }).join('');

        // Add event listeners
        list.querySelectorAll('input[name="payment"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedPaymentMethodId = parseInt(e.target.value);
                renderPaymentSelector();
            });
        });

        // Select main payment method by default if none selected
        if (selectedPaymentMethodId === null && paymentMethods.length > 0) {
            const mainPayment = paymentMethods.find(pm => pm.isMain);
            if (mainPayment) {
                selectedPaymentMethodId = mainPayment.id;
                renderPaymentSelector();
            }
        }
    }

    async function saveNewAddress() {
        const errorEl = document.getElementById('address-error');
        errorEl.classList.add('hidden');

        const street = document.getElementById('new-addr-street').value.trim();
        const number = document.getElementById('new-addr-number').value.trim();
        const apartment = document.getElementById('new-addr-apartment').value.trim();
        const city = document.getElementById('new-addr-city').value.trim();
        const postal = document.getElementById('new-addr-postal').value.trim();
        const info = document.getElementById('new-addr-info').value.trim();
        const isMain = document.getElementById('new-addr-main').checked;

        if (!street || !number || !city || !postal) {
            errorEl.textContent = 'Por favor completa todos los campos requeridos';
            errorEl.classList.remove('hidden');
            return;
        }

        try {
            const response = await createAddress({
                street,
                number,
                apartment: apartment || null,
                city,
                postalCode: postal,
                additionalInfo: info || null,
                isMain
            });

            if (response.success) {
                // Reset form
                document.getElementById('new-address-form').querySelectorAll('input').forEach(input => {
                    if (input.type === 'text') input.value = '';
                    if (input.type === 'checkbox') input.checked = false;
                });
                document.getElementById('new-address-form').classList.add('hidden');

                // Reload addresses
                await loadAddressesAndPayments();
            } else {
                errorEl.textContent = response.message || 'Error al crear direcci√≥n';
                errorEl.classList.remove('hidden');
            }
        } catch (error) {
            errorEl.textContent = 'Error al crear direcci√≥n: ' + error.message;
            errorEl.classList.remove('hidden');
        }
    }

    async function saveNewPayment() {
        const errorEl = document.getElementById('payment-error');
        errorEl.classList.add('hidden');

        const type = document.getElementById('new-payment-type').value;
        const card = document.getElementById('new-payment-card').value.trim().replace(/\s/g, '');
        const name = document.getElementById('new-payment-name').value.trim();
        const exp = document.getElementById('new-payment-exp').value.trim();
        const isMain = document.getElementById('new-payment-main').checked;

        if (!card || !name || !exp) {
            errorEl.textContent = 'Por favor completa todos los campos requeridos';
            errorEl.classList.remove('hidden');
            return;
        }

        try {
            const response = await addPaymentMethod({
                type,
                cardNumber: card,
                cardHolder: name,
                expirationDate: exp,
                isMain
            });

            if (response.success) {
                // Reset form
                document.getElementById('new-payment-form').querySelectorAll('input, select').forEach(input => {
                    if (input.type === 'text') input.value = '';
                    if (input.type === 'checkbox') input.checked = false;
                    if (input.tagName === 'SELECT') input.selectedIndex = 0;
                });
                document.getElementById('new-payment-form').classList.add('hidden');

                // Reload payment methods
                await loadAddressesAndPayments();
            } else {
                errorEl.textContent = response.message || 'Error al crear m√©todo de pago';
                errorEl.classList.remove('hidden');
            }
        } catch (error) {
            errorEl.textContent = 'Error al crear m√©todo de pago: ' + error.message;
            errorEl.classList.remove('hidden');
        }
    }

    function showError(message) {
        const errorEl = document.getElementById('error-message');
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        setTimeout(() => {
            errorEl.classList.add('hidden');
        }, 5000);
    }

    // Event listeners for address and payment forms
    document.getElementById('btn-add-address')?.addEventListener('click', () => {
        document.getElementById('new-address-form').classList.remove('hidden');
    });

    document.getElementById('btn-cancel-address')?.addEventListener('click', () => {
        document.getElementById('new-address-form').classList.add('hidden');
        document.getElementById('address-error').classList.add('hidden');
    });

    document.getElementById('btn-save-address')?.addEventListener('click', saveNewAddress);

    document.getElementById('btn-add-payment')?.addEventListener('click', () => {
        document.getElementById('new-payment-form').classList.remove('hidden');
    });

    document.getElementById('btn-cancel-payment')?.addEventListener('click', () => {
        document.getElementById('new-payment-form').classList.add('hidden');
        document.getElementById('payment-error').classList.add('hidden');
    });

    document.getElementById('btn-save-payment')?.addEventListener('click', saveNewPayment);

    document.getElementById('clear-cart').addEventListener('click', async () => {
        if (confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) {
            try {
                const response = await clearCart();

                if (response.success) {
                    cartItems = [];
                    renderCart();
                    updateTotals();
                } else {
                    showError('Error al vaciar carrito: ' + (response.message || 'Error desconocido'));
                }
            } catch (error) {
                showError('Error al vaciar carrito: ' + error.message);
                console.error('Clear cart error:', error);
            }
        }
    });

    document.getElementById('place-order').addEventListener('click', async () => {
        if (!cartItems.length) {
            showError('Tu carrito est√° vac√≠o');
            return;
        }

        const btn = document.getElementById('place-order');
        btn.disabled = true;
        btn.textContent = 'Creando pedido...';

        try {
            // Use selected address and payment method
            if (!selectedAddressId) {
                showError('Por favor selecciona una direcci√≥n de env√≠o');
                btn.disabled = false;
                btn.textContent = 'Confirmar pedido';
                return;
            }

            // Payment method is required
            if (!selectedPaymentMethodId) {
                showError('Por favor selecciona un m√©todo de pago');
                btn.disabled = false;
                btn.textContent = 'Confirmar pedido';
                return;
            }

            const notes = ''; // Notes removed from form, can be added back if needed

            const response = await createOrder({
                addressId: selectedAddressId,
                paymentMethodId: selectedPaymentMethodId,
                notes: notes
            });

            console.log('Order response:', response);

            if (response.success) {
                window.location.href = `orden.html?id=${response.data.id}`;
            } else {
                showError(response.message || 'Error al crear pedido');
                btn.disabled = false;
                btn.textContent = 'Confirmar pedido';
            }
        } catch (error) {
            console.error('Error creating order:', error);
            showError('Error al crear pedido: ' + error.message);
            btn.disabled = false;
            btn.textContent = 'Confirmar pedido';
        }
    });

    function updateAuthButton() {
        const authBtn = document.getElementById('nav-auth-btn');
        const userProfileMenu = document.getElementById('user-profile-menu');
        
        if (isLoggedIn()) {
            // Show user profile menu, hide auth button
            if (userProfileMenu) userProfileMenu.classList.remove('hidden');
            if (authBtn) authBtn.classList.add('hidden');
        } else {
            // Hide user profile menu, show auth button
            if (userProfileMenu) userProfileMenu.classList.add('hidden');
            if (authBtn) {
                authBtn.classList.remove('hidden');
                authBtn.textContent = 'Ingresar';
            }
        }
    }

    // Function to update dropdown based on user role
    function updateDropdownForRole() {
        const dropdownOrders = document.getElementById('dropdown-orders');
        const dropdownFavorites = document.getElementById('dropdown-favorites');
        const dropdownAddresses = document.getElementById('dropdown-addresses');
        const dropdownPayments = document.getElementById('dropdown-payments');
        const dropdownDivider = document.getElementById('dropdown-divider');
        
        if (!dropdownOrders || !dropdownFavorites || !dropdownAddresses || !dropdownPayments) return;
        
        const userIsAdmin = isLoggedIn() && typeof isAdmin === 'function' && isAdmin();
        
        if (userIsAdmin) {
            // Admin: Hide all client options
            dropdownOrders.classList.add('hidden');
            dropdownFavorites.classList.add('hidden');
            dropdownAddresses.classList.add('hidden');
            dropdownPayments.classList.add('hidden');
            if (dropdownDivider) dropdownDivider.classList.add('hidden');
        } else {
            // Client: Show all options
            dropdownOrders.classList.remove('hidden');
            dropdownFavorites.classList.remove('hidden');
            dropdownAddresses.classList.remove('hidden');
            dropdownPayments.classList.remove('hidden');
            if (dropdownDivider) dropdownDivider.classList.remove('hidden');
        }
    }

    // User profile dropdown toggle
    function setupProfileDropdown() {
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userProfileDropdown = document.getElementById('user-profile-dropdown');
        const profileLogoutBtn = document.getElementById('profile-logout-btn');
        
        if (userProfileBtn && userProfileDropdown) {
            userProfileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                updateDropdownForRole(); // Update dropdown before showing
                userProfileDropdown.classList.toggle('hidden');
            });
            
            document.addEventListener('click', (e) => {
                if (!userProfileBtn.contains(e.target) && !userProfileDropdown.contains(e.target)) {
                    userProfileDropdown.classList.add('hidden');
                }
            });
        }
        
        if (profileLogoutBtn) {
            profileLogoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                logoutUser();
                updateAuthButton();
                window.location.href = 'home.html';
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Update auth button
        updateAuthButton();
        setupProfileDropdown();

        // Setup auth button click handler
        const navAuthBtn = document.getElementById('nav-auth-btn');
        if (navAuthBtn) {
            navAuthBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (isLoggedIn()) {
                    logoutUser();
                    updateAuthButton();
                    window.location.href = 'home.html';
                } else {
                    window.location.href = 'home.html';
                }
            });
        }

        if (!isLoggedIn()) {
            window.location.href = 'home.html';
            return;
        }
        loadCartData();
        loadAddressesAndPayments();
    });
</script>
</body>
</html>