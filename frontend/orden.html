<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pedido confirmado | PizzUM&BurgUM</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { primary:'#FF0000', secondary:'#000000', success:'#16a34a' } } }
    }
  </script>
  <style>
    html, body { height:100%; margin:0; }
    .step-dot { width: 14px; height: 14px; border-radius: 9999px; }
    .step-active { background: #FF0000; }
    .step-done   { background: #16a34a; }
    .step-pending{ background: #d1d5db; }
  </style>
</head>
<body class="bg-gray-50 font-sans">

<!-- Hero Confirmaci√≥n -->
<header class="bg-white border-b">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center">
    <div class="mx-auto w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mb-4">
      <svg viewBox="0 0 24 24" class="w-10 h-10 text-green-600">
        <path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
      </svg>
    </div>
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">¬°Pedido confirmado!</h1>
    <p class="mt-2 text-gray-600">Estamos trabajando en tu orden. Pod√©s seguir el progreso en tiempo real.</p>
    <p id="order-id" class="mt-1 text-sm text-gray-500"></p>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Resumen -->
  <section class="lg:col-span-2 space-y-6">
    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen del pedido</h2>

      <div id="items" class="divide-y"></div>

      <dl class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6">
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Direcci√≥n</dt>
          <dd id="address" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Pago</dt>
          <dd id="payment" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Subtotal</dt>
          <dd id="subtotal" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Env√≠o</dt>
          <dd id="shipping" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4 sm:col-span-2">
          <dt class="text-gray-500 text-sm">Total</dt>
          <dd id="total" class="text-primary font-extrabold text-2xl mt-1">‚Äî</dd>
        </div>
      </dl>
    </div>

    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h3 class="text-lg font-bold text-gray-800">Hora estimada de llegada</h3>
          <p id="eta-text" class="text-gray-600">Calculando‚Ä¶</p>
        </div>
        <div class="text-center">
          <div class="text-3xl font-extrabold text-success" id="countdown">‚Äî:‚Äî</div>
          <div class="text-xs text-gray-500">tiempo restante aprox.</div>
        </div>
      </div>
    </div>

    <!-- Flujo de estado -->
    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Estado del pedido</h3>

      <!-- Mobile (vertical) -->
      <ol class="space-y-4 sm:hidden" id="steps-vertical">
        <!-- steps injected -->
      </ol>

      <!-- Desktop (horizontal) -->
      <ol class="hidden sm:flex items-center justify-between" id="steps-horizontal">
        <!-- steps injected -->
      </ol>

      <p id="status-helper" class="mt-4 text-sm text-gray-500">Actualizamos el estado autom√°ticamente.</p>
    </div>

    <div class="flex flex-wrap gap-3">
      <a href="builder.html" class="inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50">‚ûï Agregar m√°s creaciones</a>
      <a href="home.html" class="inline-flex items-center px-4 py-2 rounded-md text-white bg-primary hover:bg-opacity-90">Volver al inicio</a>
    </div>
  </section>

  <!-- Aside con mensaje grande (sticky) -->
  <aside class="lg:col-span-1">
    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6 sticky top-24 text-center">
      <div class="mx-auto w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mb-3">
        <svg viewBox="0 0 24 24" class="w-8 h-8 text-green-600">
          <path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
        </svg>
      </div>
      <div class="text-2xl font-extrabold text-gray-900">¬°Pedido en marcha!</div>
      <p class="mt-2 text-gray-600">Te avisaremos cuando est√© llegando.</p>
    </div>
  </aside>
</main>

<footer class="bg-gray-800">
  <div class="max-w-7xl mx-auto py-12 px-4 overflow-hidden sm:px-6 lg:px-8">
    <p class="text-center text-base text-gray-400">&copy; 2023 PizzUM&BurgUM. Todos los derechos reservados.</p>
  </div>
</footer>

<script>
  // --- Utils ---
  const MONEY = n => `$U ${Number(n||0).toFixed(0)}`;
  const SHIPPING_COST = { pickup: 0, standard: 120, express: 200 };

  // Lee √∫ltima orden o por ?id=
  function loadOrder(){
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const orders = JSON.parse(localStorage.getItem('orders') || '[]');
    if (id) return orders.find(o => o.id === id) || orders[orders.length-1];
    return orders[orders.length-1];
  }

  // Estimaci√≥n por m√©todo (rango min-max)
  function estimateWindow(order){
    const method = order?.shippingMethod || 'pickup';
    if (method === 'pickup')   return [15, 25];   // retiro
    if (method === 'express')  return [25, 35];
    return [45, 60]; // standard
  }

  // Genera una ETA concreta dentro del rango
  function generateETA(order){
    const [min, max] = estimateWindow(order);
    const mins = Math.floor(min + Math.random() * (max - min + 1));
    const etaDate = new Date(new Date(order.createdAt).getTime() + mins*60000);
    return { mins, etaDate };
  }

  // Construye lista de √≠tems
  function renderItems(order){
    const wrap = document.getElementById('items');
    wrap.innerHTML = '';
    (order.items || []).forEach((it) => {
      const title = it.type === 'burger' ? `üçî ${it.size || 'Burger'}`
                                         : it.type === 'pizza'  ? `üçï ${it.size || 'Pizza'}`
                                         : `üßæ ${it.title || '√çtem'}`;
      const details =
        it.type === 'burger'
          ? [
              it.bun ? `Pan: ${it.bun}` : null,
              it.patty ? `Carne: ${it.patty}` : null,
              it.doneness ? `Punto: ${it.doneness}` : null,
              it.cheese ? `Queso: ${it.cheese}` : null,
              (Array.isArray(it.sauces)&&it.sauces.length) ? `Salsas: ${it.sauces.join(', ')}` : null,
              (Array.isArray(it.extras)&&it.extras.length) ? `Extras: ${it.extras.join(', ')}` : null
            ].filter(Boolean).join(' ‚Ä¢ ')
          : [
              it.dough ? `Masa: ${it.dough}` : null,
              it.sauce ? `Salsa: ${it.sauce}` : null,
              it.cheese ? `Queso: ${it.cheese}` : null,
              (Array.isArray(it.toppings)&&it.toppings.length) ? `Toppings: ${it.toppings.join(', ')}` : null
            ].filter(Boolean).join(' ‚Ä¢ ');

      const row = document.createElement('div');
      row.className = 'py-3 flex items-center justify-between';
      row.innerHTML = `
        <div>
          <div class="font-semibold text-gray-800">${title}</div>
          <div class="text-sm text-gray-600">${details}</div>
        </div>
        <div class="font-semibold text-gray-800">${MONEY((it.total||0) * (it.qty||1))}</div>
      `;
      wrap.appendChild(row);
    });
  }

  // Definir pasos seg√∫n m√©todo de env√≠o
  function getSteps(order) {
    if (order?.shippingMethod === 'pickup') {
      return ['En cola', 'En preparaci√≥n', 'Listo para retirar'];
    }
    return ['En cola', 'En preparaci√≥n', 'En camino', 'Entregado'];
  }

  // Renderiza los pasos din√°micamente
  function renderSteps(currentIndex, steps) {
    // Vertical
    const v = document.getElementById('steps-vertical'); v.innerHTML = '';
    steps.forEach((s, i) => {
      const state = i < currentIndex ? 'step-done' : i === currentIndex ? 'step-active' : 'step-pending';
      const li = document.createElement('li');
      li.className = 'flex items-center gap-3';
      li.innerHTML = `<div class="step-dot ${state}"></div><div class="font-medium ${i<currentIndex?'text-success':i===currentIndex?'text-primary':'text-gray-500'}">${s}</div>`;
      v.appendChild(li);
    });
    // Horizontal
    const h = document.getElementById('steps-horizontal'); h.innerHTML = '';
    steps.forEach((s, i) => {
      const state = i < currentIndex ? 'step-done' : i === currentIndex ? 'step-active' : 'step-pending';
      const li = document.createElement('li');
      li.className = 'flex-1 flex flex-col items-center';
      li.innerHTML = `
        <div class="step-dot ${state} mb-2"></div>
        <div class="text-sm ${i<currentIndex?'text-success':i===currentIndex?'text-primary':'text-gray-500'} font-medium">${s}</div>
        ${i<steps.length-1 ? '<div class="w-full h-px bg-gray-200 mt-2"></div>' : ''}
      `;
      h.appendChild(li);
    });
  }

  // Mapea estatus por tiempo (ajustado para pickup)
  function statusIndexFor(order, now){
    const created = new Date(order.createdAt).getTime();
    const method = order.shippingMethod || 'pickup';

    // Duraciones aproximadas por m√©todo (min)
    const phases = {
      pickup:  { queue: 2, prep: 12 },
      standard:{ queue: 2, prep: 20, travel: 25 },
      express: { queue: 2, prep: 12, travel: 15 }
    }[method] || { queue:2, prep:20, travel:25 };

    const ms = t => t*60000;
    const t = now - created;

    if (method === 'pickup') {
      if (t < ms(phases.queue)) return 0;                           // En cola
      if (t < ms(phases.queue + phases.prep)) return 1;             // En preparaci√≥n
      return 2; // Listo para retirar
    } else {
      if (t < ms(phases.queue)) return 0;                           // En cola
      if (t < ms(phases.queue + phases.prep)) return 1;             // En preparaci√≥n
      if (phases.travel === 0) return (t < ms(phases.queue + phases.prep + 5)) ? 2 : 3; // pickup: breve "en camino" simb√≥lico
      if (t < ms(phases.queue + phases.prep + phases.travel)) return 2;  // En camino
      return 3; // Entregado
    }
  }

  // Countdown y ETA
  let etaTimer = null;
  function startCountdown(etaDate){
    const el = document.getElementById('countdown');
    function tick(){
      const diff = etaDate.getTime() - Date.now();
      if (diff <= 0){
        el.textContent = '00:00';
        clearInterval(etaTimer);
        return;
      }
      const m = Math.floor(diff/60000);
      const s = Math.floor((diff%60000)/1000);
      el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tick();
    etaTimer = setInterval(tick, 1000);
  }

  // INIT
  (function(){
    const order = loadOrder();
    if (!order){
      alert('No se encontr√≥ el pedido.');
      location.href = 'builder.html';
      return;
    }

    // IDs y resumen
    document.getElementById('order-id').textContent = `N.¬∫ de pedido: ${order.id}`;
    renderItems(order);

    const addrEl = document.getElementById('address');
    if (order.shippingMethod === 'pickup' || !order.address){
      addrEl.textContent = 'Retiro en local (Centro)';
    } else {
      const {street, city, ref} = order.address || {};
      addrEl.textContent = [street, city, ref ? `Ref: ${ref}` : null].filter(Boolean).join(' ‚Ä¢ ');
    }

    const paymentMap = { cash:'Efectivo', mp:'Mercado Pago', card:'Tarjeta' };
    document.getElementById('payment').textContent = paymentMap[order.paymentMethod] || order.paymentMethod || '‚Äî';

    document.getElementById('subtotal').textContent = MONEY(order.subtotal || 0);
    document.getElementById('shipping').textContent = MONEY(order.shippingCost || 0);
    document.getElementById('total').textContent = MONEY(order.total || 0);

    // ETA
    const { mins, etaDate } = generateETA(order);
    const etaText = order.shippingMethod === 'pickup'
      ? `Listo para retirar aprox. en ${mins} min.`
      : `Llegada estimada en ${mins} min.`;
    document.getElementById('eta-text').textContent = etaText;
    startCountdown(etaDate);

    // Estado
    const steps = getSteps(order);
    function refreshStatus(){
      const idx = statusIndexFor(order, Date.now());
      renderSteps(idx, steps);
    }
    refreshStatus();
    setInterval(refreshStatus, 15000); // refresco cada 15s
  })();
</script>
</body>
</html>
