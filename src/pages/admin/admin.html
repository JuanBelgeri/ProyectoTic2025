<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración | PizzUM & BurgUM</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF0000',
                        secondary: '#000000',
                    }
                }
            }
        }
    </script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; }
        body { overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #FF0000;
            border-radius: 10px;
        }
        /* Order Status Flow Styles */
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 9999px;
            display: inline-block;
        }
        .dot-gray { background-color: #d1d5db; }
        .dot-red { background-color: #dc2626; }
        .dot-orange { background-color: #d97706; }
        .dot-blue { background-color: #2563eb; }
        .dot-green { background-color: #16a34a; }
        .status-flow {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .status-label {
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .status-label.active {
            font-weight: 600;
        }
        .arrow {
            opacity: 0.6;
            margin: 0 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-primary to-secondary shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold text-white">PizzUM & BurgUM</span>
                    </div>
                </div>
                <div class="hidden md:ml-6 md:flex md:items-center md:space-x-8">
                    <a href="../home.html" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium">Inicio</a>
                    <!-- User Profile Dropdown (only visible when logged in) -->
                    <div id="user-profile-menu" class="relative">
                        <button id="user-profile-btn" class="flex items-center text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium focus:outline-none transition-colors">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Mi Cuenta
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="user-profile-dropdown" class="hidden absolute right-0 mt-2 w-64 rounded-lg shadow-xl bg-white border-2 border-gray-100 z-50 overflow-hidden transition-all duration-200">
                            <div class="py-2" role="menu">
                                <button id="profile-logout-btn" class="flex items-center w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-primary transition-colors duration-150 group" role="menuitem">
                                    <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Cerrar sesión
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="nav-auth-btn" class="hidden bg-white text-primary px-4 py-2 rounded-full font-bold hover:bg-gray-100 transition duration-300">
                        Ingresar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex h-[calc(100vh-4rem)]">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg border-r border-gray-200 custom-scrollbar overflow-y-auto">
            <nav class="p-4 space-y-2">
                <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                    Administración
                </div>
                <a href="#" data-section="components" class="sidebar-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-primary transition">
                    <i data-feather="package" class="w-5 h-5 mr-3"></i>
                    Productos
                </a>
                <a href="#" data-section="orders" class="sidebar-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-primary transition">
                    <i data-feather="shopping-cart" class="w-5 h-5 mr-3"></i>
                    Pedidos
                </a>
                <a href="#" data-section="sales" class="sidebar-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-primary transition">
                    <i data-feather="trending-up" class="w-5 h-5 mr-3"></i>
                    Ventas
                </a>
                <a href="#" data-section="register-admin" class="sidebar-link flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-primary transition">
                    <i data-feather="user-plus" class="w-5 h-5 mr-3"></i>
                    Registrar Admin
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto custom-scrollbar p-8">
            <!-- Components Section -->
            <section id="section-components" class="section-content">
                <div class="mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-900">Gestión de Productos</h1>
                    <p class="mt-2 text-gray-600">Administra los componentes de pizzas y hamburguesas</p>
                </div>

                <!-- Component Type Selector -->
                <div class="mb-6 bg-white rounded-lg shadow p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Componente</label>
                    <select id="component-type-select" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecciona un tipo...</option>
                        <option value="pizza-sizes">Tamaños de Pizza</option>
                        <option value="dough-types">Tipos de Masa</option>
                        <option value="sauce-types">Tipos de Salsa</option>
                        <option value="cheese-types">Tipos de Queso</option>
                        <option value="bread-types">Tipos de Pan</option>
                        <option value="meat-types">Tipos de Carne</option>
                        <option value="toppings">Toppings</option>
                        <option value="condiments">Condimentos</option>
                    </select>
                </div>

                <!-- Add Component Form -->
                <div class="mb-6 bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Agregar Nuevo Componente</h2>
                    <form id="add-component-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                            <input type="text" id="component-name" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ej: Grande">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Precio</label>
                            <input type="number" id="component-price" step="0.01" min="0" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="0.00">
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-primary text-white px-4 py-2 rounded-md font-bold hover:bg-opacity-90 transition">
                                Agregar
                            </button>
                        </div>
                    </form>
                    <p id="add-component-message" class="mt-2 text-sm hidden"></p>
                </div>

                <!-- Components List -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800">Lista de Componentes</h2>
                    </div>
                    <div class="p-6">
                        <div id="components-list" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Selecciona un tipo de componente para ver la lista</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="section-orders" class="section-content hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-900">Gestión de Pedidos</h1>
                    <p class="mt-2 text-gray-600">Administra y cambia el estado de los pedidos</p>
                </div>

                <!-- Orders Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-gray-800">Pedidos actuales</h2>
                            <button id="refresh-orders-btn" class="text-sm text-primary hover:text-opacity-80 font-medium flex items-center gap-2">
                                <i data-feather="refresh-cw" class="w-4 h-4"></i>
                                Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                        Cargando pedidos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Sales Section -->
            <section id="section-sales" class="section-content hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-900">Ventas</h1>
                    <p class="mt-2 text-gray-600">Consulta las ventas por fecha</p>
                </div>

                <!-- Date Selector -->
                <div class="mb-6 bg-white rounded-lg shadow p-6">
                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Fecha</label>
                            <input type="date" id="sales-date-input" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <button id="search-sales-btn" class="bg-primary text-white px-6 py-2 rounded-md font-bold hover:bg-opacity-90 transition">
                            Buscar Ventas
                        </button>
                    </div>
                </div>

                <!-- Sales Summary -->
                <div id="sales-summary" class="mb-6 bg-white rounded-lg shadow p-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen de Ventas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Total de Pedidos</p>
                            <p id="total-orders" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Total Vendido</p>
                            <p id="total-amount" class="text-2xl font-bold text-primary">$0.00</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Pedidos Entregados</p>
                            <p id="delivered-orders" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Pedidos Cancelados</p>
                            <p id="cancelled-orders" class="text-2xl font-bold text-red-600">0</p>
                        </div>
                    </div>
                </div>

                <!-- Sales Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800">Pedidos del Día</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="sales-tbody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                        Selecciona una fecha para ver las ventas
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Register Admin Section -->
            <section id="section-register-admin" class="section-content hidden">
                <div class="mb-6">
                    <h1 class="text-3xl font-extrabold text-gray-900">Registrar Administrador</h1>
                    <p class="mt-2 text-gray-600">Crea una nueva cuenta de administrador</p>
                </div>

                <!-- Register Admin Form -->
                <div class="bg-white rounded-lg shadow p-6">
                    <form id="form-register-admin" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nombre</label>
                                <input id="admin-firstName" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Nombre">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Apellido</label>
                                <input id="admin-lastName" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Apellido">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Documento</label>
                            <input id="admin-document" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="12345678">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                            <input id="admin-birthDate" type="date" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Teléfono</label>
                            <input id="admin-phone" type="tel" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="+54 9 11 1234-5678">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Correo electrónico</label>
                            <input id="admin-email" type="email" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="admin@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Calle</label>
                            <input id="admin-street" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Calle principal">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Número</label>
                                <input id="admin-number" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="123">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Apartamento</label>
                                <input id="admin-apartment" type="text" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Opcional">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ciudad</label>
                                <input id="admin-city" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ciudad">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Código postal</label>
                                <input id="admin-postalCode" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="12345">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Información adicional (opcional)</label>
                            <input id="admin-addressAdditionalInfo" type="text" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Ej: puerta azul">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contraseña</label>
                            <input id="admin-password" type="password" required minlength="8" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Mínimo 8 caracteres">
                        </div>
                        <button type="submit" id="register-admin-submit-btn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md font-bold hover:bg-blue-700">Registrar Administrador</button>
                        <p id="register-admin-error" class="text-sm text-red-600 hidden"></p>
                        <p id="register-admin-success" class="text-sm text-green-600 hidden"></p>
                    </form>
                    <div class="mt-4 px-4 py-2 bg-gray-50 rounded-md text-xs text-gray-500">
                        Solo usuarios administradores activos pueden registrar nuevos administradores.
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Change Order Status Modal -->
    <div id="change-status-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Cambiar Estado del Pedido</h3>
                <button id="close-status-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="change-status-form" class="space-y-4">
                <input type="hidden" id="change-status-order-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nuevo Estado</label>
                    <select id="change-status-select" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Selecciona un estado...</option>
                        <option value="EN_COLA">En cola</option>
                        <option value="EN_PREPARACION">En preparación</option>
                        <option value="EN_CAMINO">En camino</option>
                        <option value="ENTREGADO">Entregado</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-md font-bold hover:bg-opacity-90 transition">
                        Cambiar Estado
                    </button>
                    <button type="button" id="cancel-status-change" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-bold hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                </div>
                <p id="change-status-message" class="text-sm hidden"></p>
            </form>
        </div>
    </div>

    <!-- Edit Component Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Editar Componente</h3>
                <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="edit-component-form" class="space-y-4">
                <input type="hidden" id="edit-component-id">
                <input type="hidden" id="edit-component-type">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input type="text" id="edit-component-name" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Precio</label>
                    <input type="number" id="edit-component-price" step="0.01" min="0" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="edit-component-active" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    <label for="edit-component-active" class="ml-2 block text-sm text-gray-700">Activo</label>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-primary text-white px-4 py-2 rounded-md font-bold hover:bg-opacity-90 transition">
                        Guardar
                    </button>
                    <button type="button" id="cancel-edit" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-bold hover:bg-gray-300 transition">
                        Cancelar
                    </button>
                </div>
                <p id="edit-component-message" class="text-sm hidden"></p>
            </form>
        </div>
    </div>

    <script src="../../js/api.js"></script>
    <script src="../../js/ui.js"></script>
    <script>
        // Wait for scripts to load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is admin
            if (!isAdmin() || !isLoggedIn()) {
                window.location.href = '../home.html';
                return;
            }

            // Initialize shared UI components (navigation, dropdown, etc.)
            initUI();

            // Initialize feather icons
            if (window.feather) {
                feather.replace();
            }

        // Sidebar navigation
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.getAttribute('data-section');
                showSection(section);

                // Update active state
                document.querySelectorAll('.sidebar-link').forEach(l => {
                    l.classList.remove('bg-gray-100', 'text-primary');
                });
                link.classList.add('bg-gray-100', 'text-primary');
            });
        });

        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(s => {
                s.classList.add('hidden');
            });
            document.getElementById(`section-${section}`)?.classList.remove('hidden');
            
            // Load orders when orders section is shown
            if (section === 'orders') {
                loadOrders();
            }
            // Set today's date as default when sales section is shown
            if (section === 'sales') {
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('sales-date-input');
                if (dateInput) {
                    dateInput.value = today;
                }
            }
        }

        // ==================== ORDERS MANAGEMENT ====================
        
        const ORDER_STATUSES = [
            { value: 'EN_COLA', label: 'En cola', color: 'red', index: 0 },
            { value: 'EN_PREPARACION', label: 'En preparación', color: 'orange', index: 1 },
            { value: 'EN_CAMINO', label: 'En camino', color: 'blue', index: 2 },
            { value: 'ENTREGADO', label: 'Entregado', color: 'green', index: 3 }
        ];

        function getStatusIndex(status) {
            const statusObj = ORDER_STATUSES.find(s => s.value === status);
            return statusObj ? statusObj.index : -1;
        }

        function renderStatusFlow(currentStatus) {
            // Handle cancelled orders separately
            if (currentStatus === 'CANCELADO') {
                return '<span class="text-red-600 font-semibold">Cancelado</span>';
            }

            const currentIndex = getStatusIndex(currentStatus);
            if (currentIndex === -1) {
                return '<span class="text-gray-500">Estado desconocido</span>';
            }

            const flow = ORDER_STATUSES.map((status, index) => {
                let dotClass = 'dot-gray';
                let labelClass = 'status-label text-gray-500';
                
                if (index <= currentIndex) {
                    // This status has been reached or is current
                    dotClass = `dot-${status.color}`;
                    labelClass = `status-label text-${status.color}-600 ${index === currentIndex ? 'active' : ''}`;
                }

                const arrow = index < ORDER_STATUSES.length - 1 ? '<span class="arrow">→</span>' : '';
                
                return `
                    <span class="flex items-center">
                        <span class="dot ${dotClass}"></span>
                        <span class="ml-2 ${labelClass}">${status.label}</span>
                    </span>
                    ${arrow}
                `;
            }).join('');

            return `<div class="status-flow">${flow}</div>`;
        }

        async function loadOrders() {
            const tbody = document.getElementById('orders-tbody');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Cargando pedidos...</td></tr>';

            try {
                // Backend handles filtering - getAllOrders() excludes cancelled orders
                const orders = await getAllOrders();
                
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No hay pedidos registrados</td></tr>';
                    return;
                }

                // All business logic is handled by backend endpoints
                tbody.innerHTML = orders.map(order => {
                    const orderDate = new Date(order.orderDate);
                    const formattedDate = orderDate.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const itemsText = order.items && order.items.length > 0
                        ? order.items.map(item => `${item.itemName} x${item.quantity}`).join(', ')
                        : 'Sin productos';

                    const totalAmount = parseFloat(order.totalAmount || 0).toFixed(2);

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${order.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.userEmail || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${itemsText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">$${totalAmount}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                            <td class="px-6 py-4 text-sm">${renderStatusFlow(order.status)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                ${order.status === 'CANCELADO' || order.status === 'ENTREGADO' 
                                    ? '<span class="text-gray-400 text-sm">No modificable</span>'
                                    : `<button onclick="openChangeStatusModal(${order.id}, '${order.status}')" 
                                        class="bg-primary text-white px-3 py-1 rounded text-sm hover:bg-opacity-90 transition">
                                        Cambiar estado
                                    </button>`}
                            </td>
                        </tr>
                    `;
                }).join('');

                // Reinitialize feather icons for refresh button
                if (window.feather) feather.replace();
            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">Error al cargar pedidos</td></tr>';
            }
        }

        window.openChangeStatusModal = function(orderId, currentStatus) {
            document.getElementById('change-status-order-id').value = orderId;
            document.getElementById('change-status-select').value = currentStatus;
            document.getElementById('change-status-modal').classList.remove('hidden');
            if (window.feather) feather.replace();
        };

        document.getElementById('refresh-orders-btn')?.addEventListener('click', () => {
            loadOrders();
            if (window.feather) feather.replace();
        });

        document.getElementById('close-status-modal')?.addEventListener('click', () => {
            document.getElementById('change-status-modal').classList.add('hidden');
        });

        document.getElementById('cancel-status-change')?.addEventListener('click', () => {
            document.getElementById('change-status-modal').classList.add('hidden');
        });

        document.getElementById('change-status-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const orderId = document.getElementById('change-status-order-id').value;
            const newStatus = document.getElementById('change-status-select').value;

            if (!orderId || !newStatus) {
                alert('Por favor selecciona un estado válido');
                return;
            }

            try {
                const response = await updateOrderStatus(orderId, newStatus);
                const messageEl = document.getElementById('change-status-message');
                
                if (response.success) {
                    messageEl.textContent = 'Estado actualizado exitosamente';
                    messageEl.className = 'text-sm text-green-600';
                    messageEl.classList.remove('hidden');
                    
                    setTimeout(() => {
                        document.getElementById('change-status-modal').classList.add('hidden');
                        loadOrders();
                    }, 1000);
                } else {
                    messageEl.textContent = response.message || 'Error al actualizar estado';
                    messageEl.className = 'text-sm text-red-600';
                    messageEl.classList.remove('hidden');
                }
            } catch (error) {
                const messageEl = document.getElementById('change-status-message');
                messageEl.textContent = 'Error al actualizar estado: ' + error.message;
                messageEl.className = 'text-sm text-red-600';
                messageEl.classList.remove('hidden');
            }
        });

        // Component type selector
        let currentComponentType = '';
        let currentComponents = [];

        document.getElementById('component-type-select')?.addEventListener('change', async (e) => {
            currentComponentType = e.target.value;
            if (currentComponentType) {
                await loadComponents(currentComponentType);
            } else {
                document.getElementById('components-list').innerHTML = '<p class="text-gray-500 text-center py-8">Selecciona un tipo de componente para ver la lista</p>';
            }
        });

        async function loadComponents(componentType) {
            try {
                const response = await getAllComponents();
                if (!response || !response[getComponentKey(componentType)]) {
                    document.getElementById('components-list').innerHTML = '<p class="text-gray-500 text-center py-8">Error al cargar componentes</p>';
                    return;
                }

                currentComponents = response[getComponentKey(componentType)];
                renderComponents();
            } catch (error) {
                console.error('Error loading components:', error);
                document.getElementById('components-list').innerHTML = '<p class="text-red-500 text-center py-8">Error al cargar componentes</p>';
            }
        }

        function getComponentKey(componentType) {
            const mapping = {
                'pizza-sizes': 'pizzaSizes',
                'dough-types': 'doughTypes',
                'sauce-types': 'sauceTypes',
                'cheese-types': 'cheeseTypes',
                'bread-types': 'breadTypes',
                'meat-types': 'meatTypes',
                'toppings': 'toppings',
                'condiments': 'condiments'
            };
            return mapping[componentType] || componentType;
        }

        function renderComponents() {
            const list = document.getElementById('components-list');
            if (!currentComponents || currentComponents.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-8">No hay componentes disponibles</p>';
                return;
            }

            list.innerHTML = currentComponents.map(component => `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition ${component.active ? '' : 'opacity-60'}">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <h3 class="font-semibold text-gray-900">${component.name}</h3>
                            ${!component.active ? '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">Inactivo</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Precio: $${parseFloat(component.price).toFixed(2)}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditModal(${component.id}, '${component.name}', ${component.price}, ${component.active})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition">
                            Editar
                        </button>
                        <button onclick="deleteComponentConfirm(${component.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition">
                            Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Add component form
        document.getElementById('add-component-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentComponentType) {
                alert('Por favor selecciona un tipo de componente primero');
                return;
            }

            const name = document.getElementById('component-name').value.trim();
            const price = parseFloat(document.getElementById('component-price').value);

            // Basic UI validation - backend will perform all business logic validation
            if (!name || isNaN(price)) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }

            try {
                // Backend handles all business logic validation
                const response = await createComponent(currentComponentType, { name, price });
                const messageEl = document.getElementById('add-component-message');
                
                if (response.success) {
                    messageEl.textContent = 'Componente agregado exitosamente';
                    messageEl.className = 'mt-2 text-sm text-green-600';
                    messageEl.classList.remove('hidden');
                    document.getElementById('add-component-form').reset();
                    await loadComponents(currentComponentType);
                } else {
                    messageEl.textContent = response.message || 'Error al agregar componente';
                    messageEl.className = 'mt-2 text-sm text-red-600';
                    messageEl.classList.remove('hidden');
                }

                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 3000);
            } catch (error) {
                const messageEl = document.getElementById('add-component-message');
                messageEl.textContent = 'Error al agregar componente: ' + error.message;
                messageEl.className = 'mt-2 text-sm text-red-600';
                messageEl.classList.remove('hidden');
            }
        });

        // Edit modal
        window.openEditModal = function(id, name, price, active) {
            document.getElementById('edit-component-id').value = id;
            document.getElementById('edit-component-type').value = currentComponentType;
            document.getElementById('edit-component-name').value = name;
            document.getElementById('edit-component-price').value = price;
            document.getElementById('edit-component-active').checked = active;
            document.getElementById('edit-modal').classList.remove('hidden');
            if (window.feather) feather.replace();
        };

        document.getElementById('close-edit-modal')?.addEventListener('click', () => {
            document.getElementById('edit-modal').classList.add('hidden');
        });

        document.getElementById('cancel-edit')?.addEventListener('click', () => {
            document.getElementById('edit-modal').classList.add('hidden');
        });

        document.getElementById('edit-component-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('edit-component-id').value;
            const componentType = document.getElementById('edit-component-type').value;
            const name = document.getElementById('edit-component-name').value.trim();
            const price = parseFloat(document.getElementById('edit-component-price').value);
            const active = document.getElementById('edit-component-active').checked;

            // Basic UI validation - backend will perform all business logic validation
            if (!name || isNaN(price)) {
                alert('Por favor completa todos los campos correctamente');
                return;
            }

            try {
                // Backend handles all business logic validation
                const response = await updateComponent(componentType, id, { name, price, active });
                const messageEl = document.getElementById('edit-component-message');
                
                if (response.success) {
                    messageEl.textContent = 'Componente actualizado exitosamente';
                    messageEl.className = 'text-sm text-green-600';
                    messageEl.classList.remove('hidden');
                    document.getElementById('edit-modal').classList.add('hidden');
                    await loadComponents(currentComponentType);
                } else {
                    messageEl.textContent = response.message || 'Error al actualizar componente';
                    messageEl.className = 'text-sm text-red-600';
                    messageEl.classList.remove('hidden');
                }

                setTimeout(() => {
                    messageEl.classList.add('hidden');
                }, 3000);
            } catch (error) {
                const messageEl = document.getElementById('edit-component-message');
                messageEl.textContent = 'Error al actualizar componente: ' + error.message;
                messageEl.className = 'text-sm text-red-600';
                messageEl.classList.remove('hidden');
            }
        });

        // Delete component
        window.deleteComponentConfirm = async function(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este componente?')) {
                return;
            }

            try {
                const response = await deleteComponent(currentComponentType, id);
                if (response.success) {
                    alert('Componente eliminado exitosamente');
                    await loadComponents(currentComponentType);
                } else {
                    alert('Error al eliminar componente: ' + (response.message || 'Error desconocido'));
                }
            } catch (error) {
                alert('Error al eliminar componente: ' + error.message);
            }
        };

        // ==================== SALES MANAGEMENT ====================

        document.getElementById('search-sales-btn')?.addEventListener('click', async () => {
            const dateInput = document.getElementById('sales-date-input');
            if (!dateInput || !dateInput.value) {
                alert('Por favor selecciona una fecha');
                return;
            }

            await loadSalesByDate(dateInput.value);
        });

        async function loadSalesByDate(date) {
            const tbody = document.getElementById('sales-tbody');
            const summary = document.getElementById('sales-summary');
            
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Cargando ventas...</td></tr>';
            summary?.classList.add('hidden');

            try {
                // Backend handles all business logic - getOrdersByDate uses backend endpoint
                const orders = await getOrdersByDate(date);
                
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No hay pedidos para esta fecha</td></tr>';
                    summary?.classList.add('hidden');
                    return;
                }

                // Calculate summary - this is presentation logic, not business logic
                const totalOrders = orders.length;
                // Total vendido: only count orders in EN_PREPARACION or higher (exclude EN_COLA and CANCELADO)
                const validSaleStatuses = ['EN_PREPARACION', 'EN_CAMINO', 'ENTREGADO'];
                const totalAmount = orders
                    .filter(order => validSaleStatuses.includes(order.status))
                    .reduce((sum, order) => {
                        return sum + parseFloat(order.totalAmount || 0);
                    }, 0);
                const deliveredOrders = orders.filter(order => order.status === 'ENTREGADO').length;
                const cancelledOrders = orders.filter(order => order.status === 'CANCELADO').length;

                // Update summary
                if (summary) {
                    document.getElementById('total-orders').textContent = totalOrders;
                    document.getElementById('total-amount').textContent = `$${totalAmount.toFixed(2)}`;
                    document.getElementById('delivered-orders').textContent = deliveredOrders;
                    document.getElementById('cancelled-orders').textContent = cancelledOrders;
                    summary.classList.remove('hidden');
                }

                // Render table - all data comes from backend
                tbody.innerHTML = orders.map(order => {
                    const itemsText = order.items && order.items.length > 0
                        ? order.items.map(item => `${item.itemName} x${item.quantity}`).join(', ')
                        : 'Sin productos';

                    const totalAmount = parseFloat(order.totalAmount || 0).toFixed(2);

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${order.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.userEmail || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${itemsText}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">$${totalAmount}</td>
                            <td class="px-6 py-4 text-sm">${renderStatusFlow(order.status)}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading sales:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error al cargar ventas</td></tr>';
                summary?.classList.add('hidden');
            }
        }

        // ==================== REGISTER ADMIN ====================

        document.getElementById('form-register-admin')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const firstName = document.getElementById('admin-firstName').value.trim();
            const lastName = document.getElementById('admin-lastName').value.trim();
            const document_val = document.getElementById('admin-document').value.trim();
            const birthDate = document.getElementById('admin-birthDate').value.trim();
            const phone = document.getElementById('admin-phone').value.trim();
            const email = document.getElementById('admin-email').value.trim();
            const street = document.getElementById('admin-street').value.trim();
            const number = document.getElementById('admin-number').value.trim();
            const apartment = document.getElementById('admin-apartment').value.trim();
            const city = document.getElementById('admin-city').value.trim();
            const postalCode = document.getElementById('admin-postalCode').value.trim();
            const addressAdditionalInfo = document.getElementById('admin-addressAdditionalInfo').value.trim();
            const password = document.getElementById('admin-password').value.trim();

            const errorElement = document.getElementById('register-admin-error');
            const successElement = document.getElementById('register-admin-success');
            const submitBtn = document.getElementById('register-admin-submit-btn');

            // Basic UI validation - backend handles all business logic validation
            if (!firstName || !lastName || !document_val || !birthDate || !phone || !email || !street || !number || !city || !postalCode || password.length < 8) {
                errorElement.textContent = 'Por favor completa todos los campos requeridos';
                errorElement.classList.remove('hidden');
                successElement.classList.add('hidden');
                return;
            }

            const adminData = {
                firstName: firstName,
                lastName: lastName,
                document: document_val,
                birthDate: birthDate,
                phone: phone,
                email: email,
                street: street,
                number: number,
                apartment: apartment,
                city: city,
                postalCode: postalCode,
                addressAdditionalInfo: addressAdditionalInfo,
                password: password,
            };

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Registrando...';
                errorElement.classList.add('hidden');
                successElement.classList.add('hidden');

                // Backend handles all business logic validation
                const response = await registerAdmin(adminData);

                if (response.success) {
                    document.getElementById('form-register-admin').reset();
                    submitBtn.textContent = 'Registrar Administrador';
                    submitBtn.disabled = false;
                    successElement.textContent = 'Administrador registrado exitosamente';
                    successElement.classList.remove('hidden');
                } else {
                    errorElement.textContent = response.message || 'Error al registrar administrador';
                    errorElement.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Registrar Administrador';
                }
            } catch (error) {
                errorElement.textContent = 'Error al registrar administrador: ' + error.message;
                errorElement.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar Administrador';
            }
        });

            // Show components section by default
            showSection('components');
            document.querySelector('[data-section="components"]')?.classList.add('bg-gray-100', 'text-primary');
        });
    </script>
</body>
</html>
