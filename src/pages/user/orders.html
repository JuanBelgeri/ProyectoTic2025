<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pedido confirmado | PizzUM&BurgUM</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { primary:'#FF0000', secondary:'#000000', success:'#16a34a' } } }
    }
  </script>
  <style>
    html, body { height:100%; margin:0; }
    .step-dot { width: 14px; height: 14px; border-radius: 9999px; }
    .step-active { background: #FF0000; }
    .step-done   { background: #16a34a; }
    .step-pending{ background: #d1d5db; }
  </style>
</head>
<body class="bg-gray-50 font-sans">

<!-- Navigation -->
<nav class="bg-gradient-to-r from-primary to-secondary shadow-lg sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16">
      <div class="flex items-center">
        <span class="text-xl font-bold text-white">PizzUM&BurgUM</span>
      </div>
      <div class="hidden md:flex items-center space-x-8">
        <a href="../home.html" class="text-white hover:text-gray-200 text-sm font-medium">Inicio</a>
        <a href="../builder/builder.html" class="text-white hover:text-gray-200 text-sm font-medium">Crea tu pedido</a>
        <a href="checkout.html" id="cart-link" class="text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium hidden relative">
            <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            Carrito
            <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center"></span>
        </a>
        <!-- User Profile Dropdown (only visible when logged in) -->
        <div id="user-profile-menu" class="relative hidden">
            <button id="user-profile-btn" class="flex items-center text-white hover:text-gray-200 px-3 py-2 rounded-md text-sm font-medium focus:outline-none transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Mi Cuenta
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <!-- Dropdown Menu -->
            <div id="user-profile-dropdown" class="hidden absolute right-0 mt-2 w-64 rounded-lg shadow-xl bg-white border-2 border-gray-100 z-50 overflow-hidden transition-all duration-200">
                <div class="py-2" role="menu">
                    <!-- Client-only options -->
                    <a href="orders.html" id="dropdown-orders" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                        <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Mis Pedidos
                    </a>
                    <a href="favorites.html" id="dropdown-favorites" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                        <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                        Favoritos
                    </a>
                    <a href="account.html#addresses" id="dropdown-addresses" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                        <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Editar Domicilios
                    </a>
                    <a href="account.html#payments" id="dropdown-payments" class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-primary hover:text-white transition-colors duration-150 group hidden" role="menuitem">
                        <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        Editar Medios de Pago
                    </a>
                    <div id="dropdown-divider" class="border-t border-gray-200 my-1 hidden"></div>
                    <button id="profile-logout-btn" class="flex items-center w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-primary transition-colors duration-150 group" role="menuitem">
                        <svg class="w-5 h-5 mr-3 text-gray-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        Cerrar sesi√≥n
                    </button>
                </div>
            </div>
        </div>
        <button id="nav-auth-btn" class="bg-white text-primary px-4 py-2 rounded-full font-bold hover:bg-gray-100 transition duration-300">
          Ingresar
        </button>
      </div>
      <div class="md:hidden flex items-center">
        <button class="text-white hover:text-gray-200" aria-controls="mobile-menu">‚ò∞</button>
      </div>
    </div>
  </div>
</nav>

<!-- Hero Confirmaci√≥n -->
<header class="bg-white border-b">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center">
    <div class="mx-auto w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mb-4">
      <svg viewBox="0 0 24 24" class="w-10 h-10 text-green-600">
        <path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
      </svg>
    </div>
    <h1 id="page-title" class="text-3xl sm:text-4xl font-extrabold text-gray-900">Mis Pedidos</h1>
    <p id="page-subtitle" class="mt-2 text-gray-600">Segu√≠ el progreso de tus pedidos en tiempo real.</p>
    <p id="order-id" class="mt-1 text-sm text-gray-500"></p>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  <!-- Lista de pedidos (cuando no hay ID) -->
  <div id="orders-list" class="hidden space-y-6">
    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Todos tus pedidos</h2>
        <a href="../home.html" class="inline-flex items-center px-4 py-2 rounded-md text-white bg-primary hover:bg-opacity-90">
          ‚Üê Volver al inicio
        </a>
      </div>
      <div id="orders-container" class="space-y-4">
        <p class="text-gray-500">Cargando pedidos...</p>
      </div>
    </div>
  </div>

  <!-- Detalle de pedido individual (cuando hay ID) -->
  <div id="order-detail" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
    <section class="lg:col-span-2 space-y-6">
      <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen del pedido</h2>

      <div id="items" class="divide-y"></div>

      <dl class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6">
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Direcci√≥n</dt>
          <dd id="address" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Pago</dt>
          <dd id="payment" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Subtotal</dt>
          <dd id="subtotal" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4">
          <dt class="text-gray-500 text-sm">Env√≠o</dt>
          <dd id="shipping" class="text-gray-800 font-medium mt-1">‚Äî</dd>
        </div>
        <div class="bg-gray-50 rounded p-4 sm:col-span-2">
          <dt class="text-gray-500 text-sm">Total</dt>
          <dd id="total" class="text-primary font-extrabold text-2xl mt-1">‚Äî</dd>
        </div>
      </dl>
    </div>

    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h3 class="text-lg font-bold text-gray-800">Hora estimada de llegada</h3>
          <p id="eta-text" class="text-gray-600">Calculando‚Ä¶</p>
        </div>
        <div class="text-center">
          <div class="text-3xl font-extrabold text-success" id="countdown">‚Äî:‚Äî</div>
          <div class="text-xs text-gray-500">tiempo restante aprox.</div>
        </div>
      </div>
    </div>

    <!-- Flujo de estado -->
    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Estado del pedido</h3>

      <!-- Mobile (vertical) -->
      <ol class="space-y-4 sm:hidden" id="steps-vertical">
        <!-- steps injected -->
      </ol>

      <!-- Desktop (horizontal) -->
      <ol class="hidden sm:flex items-center justify-between" id="steps-horizontal">
        <!-- steps injected -->
      </ol>

      <p id="status-helper" class="mt-4 text-sm text-gray-500">Actualizamos el estado autom√°ticamente.</p>
    </div>

    <div class="flex flex-wrap gap-3">
      <a href="orders.html" class="inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50">‚Üê Ver todos los pedidos</a>
      <a href="../builder/builder.html" class="inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50">‚ûï Agregar m√°s creaciones</a>
      <a href="../home.html" class="inline-flex items-center px-4 py-2 rounded-md text-white bg-primary hover:bg-opacity-90">Volver al inicio</a>
      <button id="cancel-order-btn" class="hidden inline-flex items-center px-4 py-2 border rounded-md text-red-600 border-red-300 bg-white hover:bg-red-50">
        ‚ùå Cancelar pedido
      </button>
    </div>
  </section>

  <!-- Aside con mensaje grande (sticky) -->
  <aside class="lg:col-span-1">
    <div class="bg-white border-2 border-gray-100 rounded-lg shadow p-6 sticky top-24 text-center">
      <div class="mx-auto w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mb-3">
        <svg viewBox="0 0 24 24" class="w-8 h-8 text-green-600">
          <path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
        </svg>
      </div>
      <div class="text-2xl font-extrabold text-gray-900">¬°Pedido en marcha!</div>
      <p class="mt-2 text-gray-600">Te avisaremos cuando est√© llegando.</p>
    </div>
    </aside>
  </div>
</main>

<footer class="bg-gray-800">
  <div class="max-w-7xl mx-auto py-12 px-4 overflow-hidden sm:px-6 lg:px-8">
    <p class="text-center text-base text-gray-400">&copy; 2025 PizzUM&BurgUM. Todos los derechos reservados.</p>
  </div>
</footer>

<!-- Auth Modal -->
<div id="auth-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black bg-opacity-50"></div>
  <div class="relative max-w-md w-full max-h-[90vh] bg-white border-2 border-gray-100 rounded-lg shadow-xl overflow-y-auto">
    <div class="flex items-center justify-between px-4 py-3 border-b">
      <h3 class="text-lg font-bold text-gray-900">Tu cuenta</h3>
      <button id="auth-close" class="text-gray-400 hover:text-gray-600">‚úï</button>
    </div>
    <div class="px-6 pt-4">
      <div class="flex space-x-4 mb-4">
        <button id="tab-login" class="px-3 py-1 rounded-md bg-primary text-white text-sm font-semibold">Ingresar</button>
        <button id="tab-register" class="px-3 py-1 rounded-md bg-gray-100 text-gray-700 text-sm font-semibold">Crear cuenta</button>
      </div>

      <!-- Login Form -->
      <form id="form-login" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Correo electr√≥nico</label>
          <input id="login-email" type="email" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="tu@email.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
          <input id="login-password" type="password" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button type="submit" id="login-submit-btn" class="w-full bg-primary text-white px-4 py-2 rounded-md font-bold hover:bg-opacity-90">Ingresar</button>
        <p id="login-error" class="text-sm text-red-600 hidden"></p>
      </form>

      <!-- Register Form -->
      <form id="form-register" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Nombre</label>
            <input id="reg-firstName" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Tu nombre">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Apellido</label>
            <input id="reg-lastName" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Tu apellido">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Documento</label>
          <input id="reg-document" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="12345678">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
          <input id="reg-birthDate" type="date" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tel√©fono</label>
          <input id="reg-phone" type="tel" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="+54 9 11 1234-5678">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Correo electr√≥nico</label>
          <input id="reg-email" type="email" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="tu@email.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Calle</label>
          <input id="reg-street" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Calle principal">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">N√∫mero</label>
            <input id="reg-number" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="123">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Apartamento</label>
            <input id="reg-apartment" type="text" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Opcional">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Ciudad</label>
            <input id="reg-city" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Ciudad">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">C√≥digo postal</label>
            <input id="reg-postalCode" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="12345">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Informaci√≥n adicional (opcional)</label>
          <input id="reg-addressAdditionalInfo" type="text" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Ej: puerta azul">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Tipo de tarjeta</label>
          <select id="reg-paymentType" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary">
            <option value="">Selecciona tipo</option>
            <option value="CREDIT">Cr√©dito</option>
            <option value="DEBIT">D√©bito</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Nombre del titular</label>
          <input id="reg-cardHolder" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Nombre completo">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">N√∫mero de tarjeta</label>
          <input id="reg-cardNumber" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="1234 5678 9012 3456">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Vencimiento (MM/YY)</label>
            <input id="reg-expirationDate" type="text" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="12/26">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
          <input id="reg-password" type="password" required minlength="8" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary" placeholder="M√≠nimo 8 caracteres">
        </div>
        <button type="submit" id="register-submit-btn" class="w-full bg-primary text-white px-4 py-2 rounded-md font-bold hover:bg-opacity-90">Crear cuenta</button>
        <p id="register-error" class="text-sm text-red-600 hidden"></p>
      </form>
    </div>
    <div class="px-6 py-4 border-t text-xs text-gray-500">Al continuar aceptas nuestros T√©rminos y Pol√≠tica de Privacidad.</div>
  </div>
</div>

<script src="../../js/api.js"></script>
<script src="../../js/ui.js"></script>
<script>
  // --- Utils ---
  const MONEY = n => `$${Number(n||0).toFixed(2)}`;
  

  // Map OrderStatus to display text
  function getStatusText(status) {
    const statusMap = {
      'EN_COLA': 'En cola',
      'EN_PREPARACION': 'En preparaci√≥n',
      'EN_CAMINO': 'En camino',
      'ENTREGADO': 'Entregado',
      'CANCELADO': 'Cancelado'
    };
    return statusMap[status] || status;
  }

  // Map OrderStatus to color
  function getStatusColor(status) {
    const colorMap = {
      'EN_COLA': 'text-gray-600',
      'EN_PREPARACION': 'text-yellow-600',
      'EN_CAMINO': 'text-blue-600',
      'ENTREGADO': 'text-green-600',
      'CANCELADO': 'text-red-600'
    };
    return colorMap[status] || 'text-gray-600';
  }

  // Render list of all orders
  async function renderOrdersList() {
    const container = document.getElementById('orders-container');
    
    try {
      const response = await getUserOrders();
      
      if (!response.success || !response.data || response.data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 py-8 text-center">No tienes pedidos a√∫n. <a href="../builder/builder.html" class="text-primary hover:underline">Crear un pedido</a></p>';
        return;
      }

      container.innerHTML = response.data.map(order => {
        const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleString('es-ES') : 'Fecha desconocida';
        const statusText = getStatusText(order.status);
        const statusColor = getStatusColor(order.status);
        const totalItems = order.totalItems || 0;
        
        return `
          <div class="border-2 border-gray-100 rounded-lg p-4 hover:border-primary transition-colors">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="text-lg font-bold text-gray-800">Pedido #${order.id}</h3>
                  <span class="px-3 py-1 rounded-full text-sm font-semibold ${statusColor} bg-gray-100">${statusText}</span>
                </div>
                <p class="text-sm text-gray-600">${orderDate}</p>
                <p class="text-sm text-gray-600 mt-1">${totalItems} ${totalItems === 1 ? 'item' : 'items'} ‚Ä¢ Total: ${MONEY(order.totalAmount || 0)}</p>
              </div>
              <div class="flex gap-2">
                <a href="orders.html?id=${order.id}" class="inline-flex items-center px-4 py-2 border rounded-md text-primary border-primary bg-white hover:bg-gray-50 transition">
                  Ver detalles
                </a>
              </div>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      container.innerHTML = `<p class="text-red-600 py-8 text-center">Error al cargar pedidos: ${error.message}</p>`;
    }
  }

  // Load order from API by ID

  async function loadOrder(id){
    if (!isLoggedIn()) {
      alert('Debes iniciar sesi√≥n para ver pedidos');
      openAuthModal();
      return null;
    }

    try {
      const response = await getOrderById(id);
      if (response.success && response.data) {
        return response.data;
      }
      return null;
    } catch (error) {
      console.error('Error loading order:', error);
      alert('Error al cargar el pedido: ' + error.message);
      return null;
    }
  }


  // Construye lista de √≠tems from OrderItemResponse
  function renderItems(order){
    const wrap = document.getElementById('items');
    wrap.innerHTML = '';
    
    if (!order.items || order.items.length === 0) {
      wrap.innerHTML = '<p class="text-gray-500 py-4">No hay items en este pedido</p>';
      return;
    }

    order.items.forEach((item) => {
      const badge = item.itemType === 'HAMBURGER' ? 'üçî' : item.itemType === 'PIZZA' ? 'üçï' : 'üßæ';
      const title = `${badge} ${item.itemName || 'Item'}`;
      const details = item.itemDescription || 'Sin descripci√≥n';
      const subtotal = MONEY(item.subtotal || 0);

      const row = document.createElement('div');
      row.className = 'py-3 flex items-center justify-between';
      row.innerHTML = `
        <div>
          <div class="font-semibold text-gray-800">${title}</div>
          <div class="text-sm text-gray-600">${details}</div>
          <div class="text-xs text-gray-500 mt-1">Cantidad: ${item.quantity || 1} x ${MONEY(item.unitPrice || 0)}</div>
        </div>
        <div class="font-semibold text-gray-800">${subtotal}</div>
      `;
      wrap.appendChild(row);
    });
  }

  // Definir pasos seg√∫n estado del pedido (OrderStatus enum)
  function getSteps(order) {
    // Map OrderStatus to steps
    // OrderStatus: EN_COLA, EN_PREPARACION, EN_CAMINO, ENTREGADO, CANCELADO
    const status = order?.status || 'EN_COLA';
    
    // For simplicity, return all steps - we'll highlight based on status
    return ['En cola', 'En preparaci√≥n', 'En camino', 'Entregado'];
  }

  // Map OrderStatus to step index
  function getStatusIndex(status) {
    const statusMap = {
      'EN_COLA': 0,
      'EN_PREPARACION': 1,
      'EN_CAMINO': 2,
      'ENTREGADO': 3,
      'CANCELADO': -1
    };
    return statusMap[status] || 0;
  }

  // Renderiza los pasos din√°micamente
  function renderSteps(currentIndex, steps) {
    // Vertical
    const v = document.getElementById('steps-vertical'); v.innerHTML = '';
    steps.forEach((s, i) => {
      const state = i < currentIndex ? 'step-done' : i === currentIndex ? 'step-active' : 'step-pending';
      const li = document.createElement('li');
      li.className = 'flex items-center gap-3';
      li.innerHTML = `<div class="step-dot ${state}"></div><div class="font-medium ${i<currentIndex?'text-success':i===currentIndex?'text-primary':'text-gray-500'}">${s}</div>`;
      v.appendChild(li);
    });
    // Horizontal
    const h = document.getElementById('steps-horizontal'); h.innerHTML = '';
    steps.forEach((s, i) => {
      const state = i < currentIndex ? 'step-done' : i === currentIndex ? 'step-active' : 'step-pending';
      const li = document.createElement('li');
      li.className = 'flex-1 flex flex-col items-center';
      li.innerHTML = `
        <div class="step-dot ${state} mb-2"></div>
        <div class="text-sm ${i<currentIndex?'text-success':i===currentIndex?'text-primary':'text-gray-500'} font-medium">${s}</div>
        ${i<steps.length-1 ? '<div class="w-full h-px bg-gray-200 mt-2"></div>' : ''}
      `;
      h.appendChild(li);
    });
  }

  // Use actual order status from database
  function statusIndexFor(order){
    return getStatusIndex(order.status);
  }

  // Countdown y ETA
  let etaTimer = null;
  function startCountdown(etaDate){
    const el = document.getElementById('countdown');
    function tick(){
      const diff = etaDate.getTime() - Date.now();
      if (diff <= 0){
        el.textContent = '00:00';
        clearInterval(etaTimer);
        return;
      }
      const m = Math.floor(diff/60000);
      const s = Math.floor((diff%60000)/1000);
      el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    tick();
    etaTimer = setInterval(tick, 1000);
  }

  // Auth Modal Setup
  const tabLogin = document.getElementById('tab-login');
  const tabRegister = document.getElementById('tab-register');
  const formLogin = document.getElementById('form-login');
  const formRegister = document.getElementById('form-register');

  if (tabLogin && tabRegister && formLogin && formRegister) {
    tabLogin.addEventListener('click', () => {
      tabLogin.className = 'px-3 py-1 rounded-md bg-primary text-white text-sm font-semibold';
      tabRegister.className = 'px-3 py-1 rounded-md bg-gray-100 text-gray-700 text-sm font-semibold';
      formLogin.classList.remove('hidden');
      formRegister.classList.add('hidden');
    });

    tabRegister.addEventListener('click', () => {
      tabRegister.className = 'px-3 py-1 rounded-md bg-primary text-white text-sm font-semibold';
      tabLogin.className = 'px-3 py-1 rounded-md bg-gray-100 text-gray-700 text-sm font-semibold';
      formRegister.classList.remove('hidden');
      formLogin.classList.add('hidden');
    });

    document.getElementById('auth-close').addEventListener('click', closeAuthModal);
    document.getElementById('auth-modal').addEventListener('click', (e) => {
      if (e.target.id === 'auth-modal') closeAuthModal();
    });

    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const errorElement = document.getElementById('login-error');
      const submitBtn = document.getElementById('login-submit-btn');

      if (!email || !password) {
        errorElement.textContent = 'Por favor completa todos los campos';
        errorElement.classList.remove('hidden');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Ingresando...';
        errorElement.classList.add('hidden');

        const response = await loginUser(email, password);

        if (response.success) {
          formLogin.reset();
          submitBtn.textContent = 'Ingresar';
          submitBtn.disabled = false;
          closeAuthModal();
          alert('¬°Bienvenido! Recargando p√°gina...');
          window.location.reload();
        } else {
          errorElement.textContent = response.message || 'Error al ingresar';
          errorElement.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Ingresar';
        }
      } catch (error) {
        errorElement.textContent = 'Credenciales inv√°lidas o error de conexi√≥n';
        errorElement.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ingresar';
      }
    });

    formRegister.addEventListener('submit', async (e) => {
      e.preventDefault();

      const firstName = document.getElementById('reg-firstName').value.trim();
      const lastName = document.getElementById('reg-lastName').value.trim();
      const document_val = document.getElementById('reg-document').value.trim();
      const birthDate = document.getElementById('reg-birthDate').value.trim();
      const phone = document.getElementById('reg-phone').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const street = document.getElementById('reg-street').value.trim();
      const number = document.getElementById('reg-number').value.trim();
      const apartment = document.getElementById('reg-apartment').value.trim();
      const city = document.getElementById('reg-city').value.trim();
      const postalCode = document.getElementById('reg-postalCode').value.trim();
      const addressAdditionalInfo = document.getElementById('reg-addressAdditionalInfo').value.trim();
      const paymentType = document.getElementById('reg-paymentType').value;
      const cardNumber = document.getElementById('reg-cardNumber').value.trim().replace(/\s/g, '');
      const cardHolder = document.getElementById('reg-cardHolder').value.trim();
      const expirationDate = document.getElementById('reg-expirationDate').value.trim();
      const password = document.getElementById('reg-password').value.trim();

      const errorElement = document.getElementById('register-error');
      const submitBtn = document.getElementById('register-submit-btn');

      if (!firstName || !lastName || !document_val || !birthDate || !phone || !email || !street || !number || !city || !postalCode || !paymentType || !cardNumber || !cardHolder || !expirationDate || password.length < 8) {
        errorElement.textContent = 'Por favor completa todos los campos requeridos';
        errorElement.classList.remove('hidden');
        return;
      }

      const userData = {
        firstName, lastName, document: document_val, birthDate, phone, email, password,
        address: { street, number, apartment, city, postalCode, addressAdditionalInfo },
        paymentMethod: { paymentType, cardNumber, cardHolder, expirationDate }
      };

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando cuenta...';
        errorElement.classList.add('hidden');

        const response = await registerClient(userData);

        if (response.success) {
          formRegister.reset();
          submitBtn.textContent = 'Crear cuenta';
          submitBtn.disabled = false;
          alert('¬°Cuenta creada! Recargando p√°gina...');
          window.location.reload();
        } else {
          errorElement.textContent = response.message || 'Error al crear cuenta';
          errorElement.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Crear cuenta';
        }
      } catch (error) {
        errorElement.textContent = 'Error al crear cuenta: ' + error.message;
        errorElement.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear cuenta';
      }
    });
  }

  // Initialize shared UI components
  document.addEventListener('DOMContentLoaded', function() {
    initUI();

    // INIT
    (async function(){
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      
      if (!isLoggedIn()) {
        alert('Debes iniciar sesi√≥n para ver pedidos');
        openAuthModal();
        return;
      }

      if (id) {
      // Show order detail
      document.getElementById('orders-list').classList.add('hidden');
      document.getElementById('order-detail').classList.remove('hidden');
      document.getElementById('page-title').textContent = '¬°Pedido confirmado!';
      document.getElementById('page-subtitle').textContent = 'Estamos trabajando en tu orden. Pod√©s seguir el progreso en tiempo real.';
      
      const order = await loadOrder(id);
      if (!order){
        alert('No se encontr√≥ el pedido.');
        window.location.href = 'orders.html';
        return;
      }

      // IDs y resumen
      document.getElementById('order-id').textContent = `N.¬∫ de pedido: ${order.id}`;
      renderItems(order);

    // Address and payment from notes or show placeholder
    const addrEl = document.getElementById('address');
    if (order.notes) {
      // Try to extract address from notes
      addrEl.textContent = order.notes;
    } else {
      addrEl.textContent = 'Direcci√≥n guardada en sistema';
    }

    document.getElementById('payment').textContent = 'M√©todo de pago guardado';

    // Calculate subtotal from items
    const subtotal = order.items ? order.items.reduce((sum, item) => sum + (parseFloat(item.subtotal) || 0), 0) : 0;
    document.getElementById('subtotal').textContent = MONEY(subtotal);
    document.getElementById('shipping').textContent = MONEY(0); // Shipping not tracked separately in backend
    document.getElementById('total').textContent = MONEY(order.totalAmount || subtotal);

    // ETA based on order date
    if (order.orderDate) {
      const orderDate = new Date(order.orderDate);
      const estimatedDelivery = new Date(orderDate.getTime() + 45 * 60000); // 45 min estimate
      const mins = Math.max(0, Math.floor((estimatedDelivery - Date.now()) / 60000));
      
      if (order.status === 'ENTREGADO') {
        document.getElementById('eta-text').textContent = 'Pedido entregado';
        document.getElementById('countdown').textContent = '00:00';
      } else if (order.status === 'CANCELADO') {
        document.getElementById('eta-text').textContent = 'Pedido cancelado';
        document.getElementById('countdown').textContent = '00:00';
      } else {
        document.getElementById('eta-text').textContent = `Tiempo estimado: ${mins} min.`;
        startCountdown(estimatedDelivery);
      }
    }

    // Estado
    const steps = getSteps(order);
    function refreshStatus(){
      const idx = statusIndexFor(order);
      if (idx < 0) {
        // Cancelled order
        document.getElementById('status-helper').textContent = 'Este pedido ha sido cancelado';
      }
      renderSteps(Math.max(0, idx), steps);
    }
    refreshStatus();
    
      // Refresh status every 30 seconds
      setInterval(refreshStatus, 30000);

    // Show cancel button only if order is in EN_COLA status
    const cancelBtn = document.getElementById('cancel-order-btn');
    if (order.status === 'EN_COLA') {
      if (cancelBtn) {
        cancelBtn.classList.remove('hidden');
      }
    } else {
      if (cancelBtn) {
        cancelBtn.classList.add('hidden');
      }
    }
      
    } else {
      // Show orders list
      document.getElementById('orders-list').classList.remove('hidden');
      document.getElementById('order-detail').classList.add('hidden');
      document.getElementById('page-title').textContent = 'Mis Pedidos';
      document.getElementById('page-subtitle').textContent = 'Segu√≠ el progreso de tus pedidos en tiempo real.';
      
      await renderOrdersList();
      }
    })();
  });

  // Cancel order button handler
  document.getElementById('cancel-order-btn')?.addEventListener('click', async function() {
    const params = new URLSearchParams(location.search);
    const orderId = params.get('id');
    
    if (!orderId) {
      alert('Error: No se encontr√≥ el ID del pedido');
      return;
    }

    if (!confirm('¬øEst√°s seguro de que quieres cancelar este pedido? Esta acci√≥n no se puede deshacer.')) {
      return;
    }

    const btn = this;
    btn.disabled = true;
    btn.textContent = 'Cancelando...';

    try {
      const response = await cancelOrder(parseInt(orderId));
      
      if (response.success) {
        alert('Pedido cancelado exitosamente');
        // Reload the page to show updated status
        window.location.reload();
      } else {
        alert(response.message || 'Error al cancelar el pedido');
        btn.disabled = false;
        btn.textContent = '‚ùå Cancelar pedido';
      }
    } catch (error) {
      console.error('Error canceling order:', error);
      alert('Error al cancelar el pedido: ' + error.message);
      btn.disabled = false;
      btn.textContent = '‚ùå Cancelar pedido';
    }
  });

  // Cancel order button handler - needs to be outside DOMContentLoaded for event delegation
  // (This stays here as it was already working)
</script>
</body>
</html>
